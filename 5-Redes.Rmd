---
title: "soil_food_web_unlu"
author: "Velazco"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

En los ecosistemas las especies presentes se relacionan entre sí de
maneras diferentes y estas relaciones establecen complejas redes de
interacciones (Montoya et al. 2001). Las redes de interacciones nos
muestran todas las posibles tramas en las que las especies pueden
interactuar (Delmas et al. 2019; Kéfi et al. 2012). Las redes pueden
caracterizarse en función del tipo de interacción que representan
describiendo así redes tróficas, redes de competidores, redes
mutualistas, entre otras (Labrador 2008; Montoya et al. 2001).

El enfoque que permite integrar la diversidad de especies, las
interacciones interespecíficas, las interacciones con el ambiente, la
redundancia funcional, el papel de las especies claves y la
multiplicidad de canales de materia y energia que ocurren en los
ecosistemas es estudio de la red de interacciones (.\@.barrios2007,
.\@.briones2014, .\@.potapov2023) que permite simplificar la complejidad
de interacciones y conetarlos con diferentes parámetros que emergen el
estudio de los ecosistemas (.\@.Hooperetal2005;.\@.delmas_etal2019)

En los suelos las redes de interacciones están influenciadas por
**factores de largo plazo** tales como el clima, las características
edáficas regionales y locales, la disponibilidad de recursos para los
organismos que en el habitan, las influencias biogeográficas sobre las
comunidades y por **factores de corto plazo** como las perturbaciones
antrópicas (Kardol et al. 2016) por lo que resulta de particular interés
la respuesta de la estructura de las redes ante los distintos tipos de
disturbios y su relación con el funcionamiento del ecosistema del suelo
(Sabatté, 2011; Kardol et al., 2016).

```{=html}
<!--Las redes tróficas permiten el análisis de las interacciones de
alimentación y ha sido el enfoque más utilizado pero se ha demostrado
que incluir todos los tipos de interacciones es fundamental para
entender el funcionamiento de los ecosistemas (Kéfi et al. 2012).-->
```
Las redes tróficas permiten el análisis de las interacciones de
alimentación y es el enfoque más utilizado en ecología para describir
los canales por los cuales se mueve la materia y la energía (\@.citar)
Mediante el estudio de las redes tróficas se pueden reconocen las
especies claves y los grupos funcionales claves, definidos como el grupo
de especies con un papel semejante en el funcionamiento de un ecosistema
(Gitay y Noble, 1997) que permiten el mantenimiento de las funciones
ecológicas del suelo (\@.citar).

Las redes tróficas se apoya en la teoría de grafos en la que los nodos
(especies tróficas) y sus bordes (interacciones) determinan métricas
asociados con las redes empíricas tales como la conectividad, el grado
de correlación, la longitud de un camino trófico, etc., hasta variables
ecológicas de una comunidad en el que se incluyen por ejemplo la
riqueza, la diversidad, el máximo nivel trófico, la fracción de
omnívoros, la fracción de predación entre gremios, etc. (Digel et. al.
2014; Delmas 2019 et al. 2019; Maggioto et al. 2019).

Por lo tanto mediante el análisis se obtienen patrones generales sobre
la topología de la red y las consecuencias de estos patrones sobre la
dinámica de la comunidad y las especies constituyentes (Kéfi et al.
2012; Pimm et. al. 1991; Scheu 2001) y su estructura condiciona las
funciones en los ecosistemas (Montoya et al. 2001; Labrador 2008)

Como la estructura de las redes ecológicas condiciona el funcionamiento
intrínseco de un ecosistema (Labrador, 2008; Martín López et al., 2007)
la complejidad del entramado de la red trófica edáfica es un factor
clave en la estabilidad de los procesos del suelo (Sabatté, 2011;
Wardle, 1995), y por lo tanto en el estado de conservación del mismo que
será mayor cuanto mayor sea la estabilidad de la red de interacciones.

En las redes ecológicas las conexiones características son aquellas en
las que unas pocas especies poseen un gran número de enlaces por lo
tanto la mayoría de las especies poseen pocas conexiones (Delmas et al.
2019; Montoya et al. 2001; Pimm et al. 1991) y este es el modo en que la
diversidad biológica y el funcionamiento de los ecosistemas están
ligados (Balvanera et al., 2006).

Los grupos funcionales con especies redundantes (Martín-López 2007)
permitirán una mayor capacidad de respuesta ante las perturbaciones ya
que asegura el mantenimiento de las funciones en el ecosistema (Delmas
et al. 2019; Montoya et al. 2001; Pimm et al. 1991) y de este modo que
se puede mantener la estructura, el funcionamiento y los mecanismos de
autorregulación del ecosistema (Martín-Lopez 2007) pero la desaparición
de especies muy conectadas puede producir extinciones secundarias y
fragmentaciones de la red (Montoya et al. 2001)

<!--Los componentes de los sistemas ecológicos no funcionan aislados sino a través de interacciones de complejidad variable y su organización se encuentra enmarcada por factores evolutivos, dinámicos y energéticos (Saravia 2018). La modelación matemática resulta en una herramienta clave para la comprensión del funcionamiento de los sistemas biológicos porque cuenta con la propiedad de síntesis de variables con efectos dominantes (Polo 2013).-->

Los estudios de redes de interacciones proporcionan información acerca
de la estructura autoorganizada de los ecosistemas (Momo 2018); en las
redes tróficas del suelo se busca comprender los efectos sobre la
descomposición de la materia orgánica y el ciclo de nutrientes (Scheu
2002) y otras funciones del ecosistema edáfico (\@citar) que son tema
central de los investigadores al centrarse en los flujos de energía y en
las redes tróficas de las comunidades de diferentes sistemas de uso del
suelo (Scheu 2002; potapov2023(historicalperspe)).

La comprensión de la estructura y topología de la red se constituye en
una herramienta útil para describir y cuantificar la complejidad de los
ecosistemas y de cómo las comunidades de la mesofauna edáfica responden
a las perturbaciones asociadas al manejo del suelo (Delmas et al. 2019;
Maggioto et. al. 2019)

Digel et al. (2014) utilizó las redes tróficas de 48 comunidades del
suelo de bosques alemanes y comparó 22 parámetros de las métricas y
topología de las redes tróficas entre las comunidades del suelo y las
comunidades de ecosistemas acuáticos y terrestres. En la Argentina
Maggioto et al. (2019) utilizaron las herramientas del análisis de las
redes tróficas del suelo para estudiar los efectos de forestar
pastizales naturalizados de la Pampa Húmeda. En este estudio, compararon
11 parámetros entre 2 sitios forestados y un pastizal naturalizado.

En ambos casos el análisis de la estructura de las redes fue realizado
comparando diferentes comunidades ó diferentes manejos del suelo,
hallando características particulares para cada comunidad y coinciden en
que la estructura general de las redes no varía considerablemente según
el uso del suelo, aunque en los sitios bajo estudio no implicaron
manejos de suelos en el que hubiera prácticas agrícolas intensivas.

.\@.potapov2023 declara que el uso de las redes tróficas es una
herramienta esencial que debe ser utilizada en los ecosistemas
terrestres para comprender el funcionamiento del ecosistema del suelo,
ya que une los aspetos relacionados con la diversidad específica, la
diversidad de rasgos, la diversidad funcional y los aspectos que se
relacionan con la estabilidad y resiliencia de estos sistemas.

Por otra parte, a las redes de interacciones, pueden relacionarse rasgos
como el peso corporal con los nodos de la red y atributos poblacionales
como la abundancia de los taxones, lo que permite relacionar tanto
parámetros fisiológicos como el metabolismo y el uso de los recursos,
como parámetros ecológicos tales como las interacciones tróficas y las
adaptaciones de estos organismos ante cambios en el ambiente
[.\@.pey2014; .\@.white2007; .\@.turnbull2014].

En este contexto, pretendemos comparar las métricas estruturales, los
flujos de energía vinculados a las redes tróficas, las fuerzas de
interacciones y la estabilidad estructural de las redes tróficas de la
fauna del suelo entre ambientes con distintas intensidades en el tiempo
de uso del suelo.

En este contexto, el presente trabajo busca comparar la estabilidad
estructural de las redes de tróficas de la fauna del suelo de suelos
Argiudoles típicos de la Pampa Ondulada entre ambientes con distintas
estrategias en el uso del suelo, como aproximación a distintas
intensidades de perturbación: a) suelos sin uso agropecuario, tales como
un pastizal naturalizado sin uso por mas de 50 años o un lote clausurado
sin uso por más de 30 años, que servirán como sistema de referencia; b)
suelos con uso pastoril como forraje para el ganado considerados como
sistemas con intensidad de uso intermedio o leve; y c) suelos con
actividad agrícola contínua considerado como sistema con intensidad de
uso alta.

<!--, una sin uso de suelo correspondiente a un pastizal naturalizado que servirá como sistema de referencia y un sistema de alta perturbación que se corresponde con un sistema agrícola intensivo con más de 50 años de actividad ininterrumpida.-->

Para la construcción y el modelado de la red de interacciones tróficas
de la fauna del suelo es necesario conocer a) tanto las comunidades que
habitan los diferentes ambientes como las características físicas y
químicas de los ambientes, b) además es necesario recopilar información
sobre los recursos tróficos que estos animales utilizan para poder
modelar la matriz de interacciones tróficas (.\@.delmas_etal_2019), c)
de manera complementaria tener información sobre rasgos funcionales
específicamente sobre el peso corporal de los taxas involucrados
(.\@.laigle_etal_2018) que permite conocer las fuerzas de
interacciones(.\@.deRuiter_etal_1995), los flujos de energía através de
la red (.\@.potapov2023, .\@.barnes_etal_2017) y calcular la resiliencia
y estabilidad de los sistemas bajo estudio (.\@.mooreandderutier_2018,
.\@.gauzen_etal_2018, .\@.allisina_etal_2008).

Entonces a partir de un suelo natural definido como referencia donde se
encuentran las características de un suelo no disturbado, se podrían
comparar parámetros estructurales y funcionales de la comunidad de
microartrópodos edáficos que permitan evaluar la estabilidad de la red
de interacciones como indicadora del estado de conservación del suelo y
determinar a través de su estudio la sustentabilidad de los sistemas de
manejo [@bedano2007; @socarras2013].

# Metodología

## Construccion de la red

## Métricas y estadísticas

# Resultados

```{r lib, include=FALSE}

{library(tidyverse);library(statnet);library(network);
  library(igraph);library(intergraph);library(multiweb)}
set.seed(167)

```

```{r dtb,include=FALSE}
#Carga datos, comunidad completa, abundancia, pesos corporales medios, de suelos UNLu
SFW_unlu <- read.delim(
  "database/unlu_ab_mass_mean_web.txt"
  )
#carga datos, suelos ROSANA, Chivilcoy y Navarro
completo <- readxl::read_excel("database/soil_networks.xlsx", sheet = "Ro_web")
```

```{r densidad_unlu,include=FALSE}
#microfauna (se contaron los nemátodos de 4 sacabocados)
sup.bocado.micro <- (1/(pi*2.5^2/10000))*4
#mesofauna (se contaron y extrajeron de 3 frasquitos homojeneizados del monolito)
sup.bocado.meso <- (1/(pi*2.5^2/10000))*3
#macrofauna (superficie estandar 25 x 25)
sup.monolito <- 1/(0.25*0.25)

unlu_D<-SFW_unlu%>%
  mutate(nombre=paste(sitio,replica))%>%
           mutate(
             D=floor(case_when(
  size_class=="macro"~ sup.monolito*abundance,
  size_class=="meso"~ sup.bocado.meso*abundance,
  size_class=="micro"~ sup.bocado.micro*abundance)
  ),
  biomass=body_mass*D
  )

web<-unlu_D%>%
  group_by(nombre,sitio,replica,taxa)%>%
  summarise(body=mean(body_mass,na.rm=TRUE),
            biomass=mean(biomass,na.rm=TRUE))%>%
  distinct(taxa,.keep_all=TRUE)

```

```{r recurso_base_unlu,echo=FALSE}
#se utilizaron la biomasa estimada por m2 hasta los 5 cm

#recursos base, hongo, bacteria, protozoa
sitio<-c("L","L","L","P","P","P","R","R","R",
         "L","L","L","P","P","P","R","R","R",
         "L","L","L","P","P","P","R","R","R")
replica<-c(1,2,3,1,2,3,1,2,3,
           1,2,3,1,2,3,1,2,3,
           1,2,3,1,2,3,1,2,3)
taxa<-c("bac","bac","bac","bac","bac","bac","bac","bac","bac",
        "fungi","fungi","fungi","fungi","fungi","fungi","fungi","fungi","fungi",
        "proto","proto","proto","proto","proto","proto","proto","proto","proto")
biomass<-c(31182224-31182224*0.025,10506443-10506443*0.025,68378710-68378710*0.025,
           117115935-117115935*0.025,90987488-90987488*0.025,131508231-131508231*0.025,
           56295276-56295276*0.025,90096858-90096858*0.025,38740835-38740835*0.025,
          101342228-101342228*0.025,147090202-147090202*0.025,56982258-56982258*0.025,
          161034411-161034411*0.025,166810394-166810394*0.025,
          153426270-153426270*0.025,136717098-136717098*0.025,165177572-165177572*0.025,
          135592922-135592922*0.025,132524452*0.05,157596645*0.05,125360968*0.05,
          278150346*0.05,257797882*0.05,284934501*0.05,193012374*0.05,
          255274430*0.05,174333757*0.05)

rec_base<-data.frame(sitio,replica,taxa,biomass)
rec_base<-rec_base%>%
             mutate(
             body=case_when(
  taxa=="bac"~ 9.5e-4, #peso medio bacteria, segun digel, en ug
  taxa=="fungi"~ 2.3e-1, #si considero el promedio entre ambos sería 5.560547e-05, 
                      #pero se coloca -999 cuando no hay info. #nueva info 4/4/24
                      # Andres Pilar et al 2016. soilfoodweb prairie
  taxa=="proto"~ 1.1121e-3)#peso medio, segun digel y en microgramos
  )
  
rec_base<-rec_base%>%
  mutate(nombre=paste(sitio,replica))

rec_base<-rec_base[,c("nombre","sitio","replica","taxa","body","biomass")]

web<-rbind(rec_base, web)

```

```{r redes_sitio_unlu,echo=FALSE}
web0<-web%>%
  group_by(sitio,taxa)%>%
  summarise(body=mean(body,na.rm=TRUE),
            biomass=mean(biomass,na.rm=TRUE))%>%
  distinct(taxa,.keep_all=TRUE)
#######
#Eficiencias de consumo dicho por mi, justificación quien sabe
#Ver la carpeta de coefbiol la biblio con las eficiencias. Libro Colemann p.e.
#Detritivoros 0.15
#Herbívoros 0.2
#Omnívoros 0.4
#Microbivoros y geófagos 0.6
#predadores 0.75

micf<-c("alycidae", "bac","diplura",
  "Aporrectodea caliginosa","Aporrectodea rosea","Bimastos parvus",
  "Aporrectodea trapezoides","Bimastos beddardi sophiae",
   "ceratozetoidea","cryptophagidae","enchytraeida","entomobridae",
  "epilhomanioidea","eremobelbidae","Eukerria halophila","fungi","galumnidae",
   "Glossoscolex sp.","isotomidae","juvenil","macropilina","Microscolex phosphoreus",
  "nem_bacterivoro", "nem_fitofago","nem_fungivoro","Octalasion cyaneum",
  "Octolasion tyrtaeum","onichiuridae","oppioidea","oribatulidae",
  "oripodidae","protura","scheloribatidae","symphyla","symphypleona"
  )
pred<-c("ameroseidae","anystidae","arctacaridae","bdelloidea","carabidae",
  "coccinelidae","cunaxide","dermanisoidea","eupodoidea","eviphididae",
  "geophylomorpha","grillopalpidae","ichtyostomatogasteridae", "laelapidae", "larva_carabidae","linyphiidae","lycosidae","nem_predador","mesostigmata",
  "ologamasidae","parasitidae",  "penthalidae","proto","pseudoscorpionida",
  "rhagidiidae","rhodacarioidea","staphiliniidae","tarsonemidae","teneriffidae",
  "trombidiidae","tydeioidea", "uropodoidea","veigaioidea") 
det<-c("anthribidae","blattodea","gasteropoda","diplopoda","elateriforme",
  "embrioptera","eupthiracaroidea","larva_coleoptero",
 "larva_diptera","larva_elateridae","larva_scarabidae","larva_sciaridae",
  "larva_tenebrionidae","limnozetidae","oniscidea","ptilidae","pupa_diptera",
 "tenebrionidae","terebrantia","trogossitidae")
herb<-c("aphidoidea","cicadidae","coleoptera_suctor","hemiptero","larva_curculionidae",
   "ortoptero","thysanoptera")
omn<-c("astigmata","formicidae","hipogastruridae","nem_omnivor","tardigrado"  )

no_a<-c("nematomorpha")  
web0$ef<-NA
web0$ef[web0$taxa%in%micf]<-0.6
web0$ef[web0$taxa%in%pred]<-0.75
web0$ef[web0$taxa%in%det]<-0.25
web0$ef[web0$taxa%in%herb]<-0.125
web0$ef[web0$taxa%in%omn]<-0.4
web0$ef[web0$taxa%in%no_a]<-0.075

L<-web0%>%filter(sitio=="L")
P<-web0%>%filter(sitio=="P")
R<-web0%>%filter(sitio=="R")

#Pesos corporales
body_L<-c(L$body,0,0,0,0)
body_R<-c(R$body,0,0,0,0)
body_P<-c(P$body,0,0,0,0)
#biomasas
#tejido vegetal se asume 25% mas que la materia orgánica aunque puede ser 125% más
bm_L<-c(L$biomass,
        (77.0321/0.0625)*0.3*1e6, #Hojarasca
        mean(R[R$taxa!="fungi"&R$taxa!="bac"&R$taxa!="proto",]$biomass)*0.05, #Carroña
        1.25*0.0273*1.2*50000*1e6,#Tej_veg
        0.4*0.0273*1.2*50000*1e6)#humus; 0.4 proxi POM, %MO, 1.2 DAP, 50k volumen suelo
bm_R<-c(R$biomass,
        55.753/0.065*0.3*1e6, #Hojarasca
        mean(R[R$taxa!="fungi"&R$taxa!="bac"&R$taxa!="proto",]$biomass)*0.05, #carroña
        1.25*0.0352*1.2*50000*1e6, #tej_veg
        0.4*0.0352*1.2*50000*1e6) #"humus" = POM = 0.4MO
bm_P<-c(P$biomass,
        (58.63/0.0625)*0.3*1e6, #Hojarasca
        mean(P[P$taxa!="fungi"&P$taxa!="bac"&P$taxa!="proto",]$biomass)*0.05, #carroña
        1.25*0.0352*1.2*50000*1e6, #Tej_veg
        0.4*0.0309*1.2*50000*1e6) #Humus
#######

```

```{r datosRO, include=FALSE}

#completo <- readxl::read_excel("database/soil_networks.xlsx", sheet = "Ro_web")
#Hacer red por sitio, no por estación, ignorar la macrofauna 
#ya que no tuvieron un correcto diseño de muestreo
#representan 166 registros macrofauna / 8662 registros totales
#lombrices 1454 / 8662 totales, pero correctamente muestreados


base<-completo%>%filter(class!="macrofauna")
#Es el factor de conversión para llevar las abundancias a densidad

#Densidad de los demás es 2.5²*3.14 = n()/0,00471 
sup.bocado <- 1/(pi*2.5^2/10000)
#Densidad de lombrice en 25*25 = a n()/0.0625
sup.monolito <- 1/(0.25*0.25)


####### 
#por sitio
#A partir de aqui determina las abundancias
base.sitio<-base%>%group_by(system,site,class,order,specie) %>%
  summarise(abundance=n(), bio.ind=mean(biomass),
            bm=(mean(bm)),POM=mean(POM))%>%distinct(specie,.keep_all=TRUE)

#densidad y biomasa
ab.sitio<-base.sitio%>%
  mutate(D=case_when(order=="crassiclitellata"~sup.monolito*abundance,
                     order!="crassiclitellata"~sup.bocado*abundance),
         BT=case_when(order=="crassiclitellata"~sup.monolito*abundance*bio.ind,
                      order!="crassiclitellata"~sup.bocado*abundance*bio.ind))

base1 <-ab.sitio %>% group_by(system,site) %>%  
  summarise(humus=mean(POM),bm=(mean(bm)))%>%
  mutate(bacteria=case_when(system=="A"~bm*0.35,system=="G"~bm*0.3,system=="N"~bm*0.25),
         hongo=((bm-(0.05*bm))-bacteria),
         microfauna=(0.05*bm*0.25),
         nem_f=(0.05*bm*0.75*0.4),nem_b=(0.05*bm*0.75*0.3),nem_phy=(0.05*bm*0.75*0.14),
         nem_pr=(0.05*bm*0.75*0.08),nem_om=(0.05*bm*0.75*0.08))%>%distinct(site,.keep_all=TRUE)

# matriz red
mRO<-ab.sitio[,c("system","site","specie","bio.ind","D","BT")]
mRO_rec<-base1%>% 
  pivot_longer(cols = c("humus","bacteria","hongo","microfauna","nem_f",
                        "nem_b","nem_phy","nem_pr","nem_om"),
              names_to = "specie",
              values_to = "BT"
              )
#en pivot longer no usar, distinct(site,.keep_all=TRUE), porque elimina las observaciones con las
#mismas filas y columnas

#en microgramos
{mRO_rec$bio.ind<-NA
mRO_rec[mRO_rec$specie=="humus","bio.ind"]<-1
mRO_rec[mRO_rec$specie=="bacteria","bio.ind"]<-9.5e-4
mRO_rec[mRO_rec$specie=="hongo","bio.ind"]<-2.3e-1
mRO_rec[mRO_rec$specie=="microfauna","bio.ind"]<-3.3363e-1 # este sale de promediar, 
                                          #lo que los protozoos "pesan"

#para los nemátodos utilizo el promedio GLOBAL de peso de los encontrados en suelos de Luján

#fitófago, luján 1.02ug, digel
#fungivoro, luján 5,184 ug, digel
#bacterivoro, luján 1,854, digel
#omnivoro, luján 16,89 ug, digel
#predador, luján 4,58 ug, digel
mRO_rec[mRO_rec$specie=="nem_b","bio.ind"]<-1.854
mRO_rec[mRO_rec$specie=="nem_f","bio.ind"]<-5.184
mRO_rec[mRO_rec$specie=="nem_phy","bio.ind"]<-1.02
mRO_rec[mRO_rec$specie=="nem_om","bio.ind"]<-16.89
mRO_rec[mRO_rec$specie=="nem_pr","bio.ind"]<-4.58
#elijo solo los recursos y le asigno nombre

mRO_rec$D<-mRO_rec$BT/mRO_rec$bio.ind}
mRO_rec<-mRO_rec[c("system","site","specie","bio.ind","D","BT")]

#matriz Rosana. Completo con recursos
mRO<-rbind(mRO,mRO_rec)
#corregir nombres de taxas para que sean simlares
{
mRO$specie[mRO$specie=="acaroidea"]<-"astigmata"
mRO$specie[mRO$specie=="Apo_cal"]<-"Aporrectodea caliginosa"
mRO$specie[mRO$specie=="Apo_ros"]<-"Aporrectodea rosea"
mRO$specie[mRO$specie=="Apo_tra"]<-"Aporrectodea trapezoides"
mRO$specie[mRO$specie=="hongo"]<-"fungi"
mRO$specie[mRO$specie=="bacteria"]<-"bac"
mRO$specie[mRO$specie=="dermanyssoidea"]<-"dermanisoidea"
mRO$specie[mRO$specie=="entomobroidea"]<-"entomobridae"
mRO$specie[mRO$specie=="epilohmannioidea"]<-"epilhomanioidea"
mRO$specie[mRO$specie=="euker"]<-"Eukerria stagnalis" #agregar
mRO$specie[mRO$specie=="euphthiracaroidea"]<-"eupthiracaroidea"
mRO$specie[mRO$specie=="galumnioidea"]<-"galumnidae"
mRO$specie[mRO$specie=="humus"]<-"hummus"
mRO$specie[mRO$specie=="hypogastruridae"]<-"hipogastruridae"
mRO$specie[mRO$specie=="lom_juv"]<-"juvenil"
mRO$specie[mRO$specie=="Mic_pho"]<-"Microscolex phosphoreus"
mRO$specie[mRO$specie=="Mic_dub"]<-"Microscolex dubius" #agregar
mRO$specie[mRO$specie=="microfauna"]<-"proto"
mRO$specie[mRO$specie=="nem_b"]<-"nem_bacterivoro"
mRO$specie[mRO$specie=="nem_f"]<-"nem_fungivoro"
mRO$specie[mRO$specie=="nem_phy"]<-"nem_fitofago"
mRO$specie[mRO$specie=="nem_om"]<-"nem_omnivor"
mRO$specie[mRO$specie=="nem_pr"]<-"nem_predador"
mRO$specie[mRO$specie=="octacy"]<-"Octalasion cyaneum"
mRO$specie[mRO$specie=="octala"]<-"Octalasion lacteum" #agregar
mRO$specie[mRO$specie=="onychiuridae"]<-"onichiuridae"
#oribatido agregar
mRO$specie[mRO$specie=="oripodoidea"]<-"oripodidae"
mRO$specie[mRO$specie=="parasitoidea"]<-"parasitidae"
mRO$specie[mRO$specie=="rhodacaroidea"]<-"rhodacarioidea"
mRO$specie[mRO$specie=="trombidioidea"]<-"trombidiidae"
mRO$specie[mRO$specie=="tydeoidea"]<-"tydeioidea"

}

webRO<-mRO%>%
  group_by(system,specie)%>%
  summarise(body=mean(bio.ind,na.rm=TRUE),
            d=mean(D,na.rm=TRUE),
            biomass=mean(BT,na.rm=TRUE))%>%
  distinct(specie,.keep_all=TRUE)

N<-webRO%>%filter(system=="N")
G<-webRO%>%filter(system=="G")
A<-webRO%>%filter(system=="A")

#Pesos corporales
body_N<-c(N$body,0,0,0,0)
body_G<-c(G$body,0,0,0,0)
body_A<-c(A$body,0,0,0,0)

```
<!-- # Biomasas
# Hojarasca, Dato tomado de biomasas y abundancias de la red unlu
# Esto es el peso de la hojarasca encontrada en los 25*25 cm
# 0.3 es el coeficiente de peso seco
# L= 77,0321g/0.0625m2*0.3 P= 58.63g/0.0625m2*0.3 R= 55.753g/0.065m2*0.3
# asumir 40% de la MOS es POM
# %MO L=2.73% R=3.52% P= 3.09%
# dap aprox. 1.2
# Datos tomados de fyq_unlu, determinación de la materia orgánica.
# Tej_veg sin datos, seria conocer el peso de las raices y/o sus metabolitos liberados
# Como proxy, decimos que es una vez y media el contenido de materia orgánica
# Carroña, puede ser el 5% de la biomasa promedio total de los invertebrados
# L = 6980566 *0.01, R= 9231538*0.01, P=7122637*0.01
# Fórmula: mean(P[P$taxa!="fungi"&P$taxa!="bac"&P$taxa!="proto",]$biomass)
#Lavelle: Root biomass may be extremely high in soils and often constitutes the major resource for soil organisms. 
#raices 2mg por cm en figure III.19 soil organims. root. pp 237
#####
-->


```{r Gamma_matrix, include=FALSE}

#Esta es la mtriz global. Falta colocar aquellos ácaros y colémbolos de la matriz de Rosana

webG<-web%>%
  group_by(taxa)%>%
  distinct(taxa,.keep_all=TRUE)

#print(R$taxa)
#agregar crotonioidea; Octalasion lacteum; Microscolex dubius; Eukerria stagnalis; brachychthonioidea
#provenientes de la comunidad Rosana
sp_G<-c("litter","carrion","tej_veg","hummus","isoptera","crotonioidea","Octalasion lacteum","Microscolex dubius","Eukerria stagnalis","brachychthonioidea","oribatido","limnozetidae",levels(as.factor(webG$taxa)))
mG<-matrix(nrow = length(sp_G),ncol = length(sp_G),
           dimnames = list(sp_G,sp_G))
#reemplazar NA por ceros

mG[is.na(mG)] <- 0
{
#####
#Microflora
mG["bac",c("hummus","litter","carrion")]<-1
mG["fungi",c("hummus","tej_veg","carrion","litter")]<-1
#Microfauna
mG["proto",c("bac","hummus","proto")]<-1
mG[c("enchytraeida","tardigrado"),c("bac","hummus","proto","fungi")]<-1
mG[c("enchytraeida"),c("litter")]<-1
mG["nem_predador",c("nem_predador","nem_omnivor","nem_fitofago",
                    "nem_bacterivoro","nem_fungivoro","proto","tardigrado")]<-1
mG["nem_omnivor",c("nem_fitofago","nem_bacterivoro","nem_fungivoro","proto",
                   "tardigrado","bac","fungi","hummus")]<-1
mG["nem_fitofago","tej_veg"]<-1
mG["nem_fungivoro","fungi"]<-1
mG["nem_bacterivoro","bac"]<-1

#####
#lombrices
mG[c("juvenil","Aporrectodea caliginosa",
     "Aporrectodea rosea","Aporrectodea trapezoides",
     "Bimastos beddardi sophiae","Bimastos parvus",
     "Eukerria halophila","Glossoscolex sp.","Octalasion lacteum", "Microscolex dubius",
     "Eukerria stagnalis","Microscolex phosphoreus","Octalasion cyaneum","Octolasion tyrtaeum"),
   c("litter","bac","fungi","proto","hummus")]<-1
#####
mG["astigmata",c("bac","fungi","nem_fitofago",
                    "nem_bacterivoro","nem_fungivoro","proto")]<-1


mG["coccinelidae",c("aphidoidea","thysanoptera","terebrantia","cicadidae")]

mG[c("aphidoidea","coleoptera_suctor","thysanoptera","hemiptero",
     "cicadidae","ortoptero","terebrantia","embrioptera"),
   c("tej_veg")]<-1 #este aparece, pero tal vez no se alimente¿?

#grandes detritivoros
mG[c("oniscidea","blattodea","diplopoda","gasteropoda",
     "larva_coleoptero","larva_tenebrionidae","larva_curculionidae",
     "larva_diptera",
     "larva_elateridae","larva_scarabidae","larva_sciaridae",
     "pupa_diptera","trogossitidae","cryptophagidae",
     "ptilidae","elateriforme","tenebrionidae","anthribidae"),
   c("fungi","litter","carrion")]<-1

#####

#Grandes mesostigmatas
#arctacaridae in the review not information of this group
#Krantz say " it may represent the sister group of the gamasine subcohorrs 
# Parasitiae and Dermanyssiae, 
#eviphididae, laelapidae, ologamasidae, parasitidae, veigaioidea

mG[c("arctacaridae","dermanisoidea","eviphididae", 
     "ichtyostomatogasteridae","laelapidae","ologamasidae", 
     "parasitidae", "veigaioidea","rhagidiidae","bdelloidea",
     "cunaxide","teneriffidae","trombidiidae"),
   c("enchytraeida","nem_predador","nem_omnivor","nem_fitofago",
     "nem_bacterivoro","nem_fungivoro","proto","astigmata",
     "limnozetidae","ceratozetoidea","diplura","entomobridae",
     "epilhomanioidea","eremobelbidae","eupthiracaroidea",
     "galumnidae","hipogastruridae","isotomidae","larva_diptera",
     "larva_sciaridae","onichiuridae","oppioidea","oribatulidae",
     "oripodidae","protura", "scheloribatidae","symphyla",
     "symphypleona", "teneriffidae","tardigrado",
     "alycidae", "anystidae","macropilina","ameroseidae",
     "arctacaridae","dermanisoidea","eviphididae", 
     "ichtyostomatogasteridae","laelapidae","ologamasidae", 
     "parasitidae", "veigaioidea",
     "bdelloidea","penthalidae","cunaxide","trombidiidae",
     "eupodoidea","tydeioidea","alycidae","anystidae","tarsonemidae",
     "rhodacarioidea","teneriffidae","rhagidiidae",
     "uropodoidea")]<-1
#arctacaridae segun Krantz dieta similar a Parasitidae
#dermanisoidea una amplia superfamilia, en ella estan los Laelapidae, Ascoidea, etc,
mG[c("uropodoidea","mesostigmata"),c("nem_predador","nem_omnivor","nem_fitofago",
                   "nem_bacterivoro","nem_fungivoro","proto","tardigrado")]<-1

#mesostigmata pequeño
mG[c("rhodacarioidea"),
   c("nem_predador","nem_omnivor","nem_fitofago",
     "nem_bacterivoro","nem_fungivoro","proto","tardigrado",
     "onichiuridae","hipogastruridae","isotomidae","symphypleona",
     "protura","diplura","symphyla",
     "entomobridae","enchytraeida")]<-1 #se alimentan solo de colembolos, 
                                        #evitando acaros
#####
#Prostigmata omnivoro
mG[c("eupodoidea","ameroseidae","penthalidae","tydeioidea",
     "alycidae","anystidae","tarsonemidae"),
   c("bac","fungi","carrion",
     "nem_predador","nem_omnivor","nem_fitofago",
     "nem_bacterivoro","nem_fungivoro","proto","tardigrado",
     "onichiuridae","hipogastruridae","isotomidae","symphypleona",
     "entomobridae","symphyla","protura","diplura","astigmata")]<-1

######
# Macropredadores
# acaros, colembolos, otros microartrópodos
mG[c("carabidae","staphiliniidae","pseudoscorpionida"),
   c("enchytraeida","astigmata","limnozetidae","ceratozetoidea","diplura",
     "entomobridae","epilhomanioidea","eremobelbidae","eupthiracaroidea","eupodoidea",
     "eviphididae","galumnidae","hipogastruridae","isotomidae",
     "mesostigmata","laelapidae","larva_diptera","larva_sciaridae",
     "ologamasidae","parasitidae","bdelloidea","onichiuridae","oppioidea",
     "oribatulidae","oripodidae","protura", "scheloribatidae","symphyla",
     "symphypleona", "teneriffidae","rhodacarioidea","tardigrado",
     "rhagidiidae","tydeioidea","uropodoidea","veigaioidea","arctacaridae",
     "bdelloidea","penthalidae","cunaxide","trombidiidae",
     "ameroseidae","arctacaridae","dermanisoidea", 
     "ichtyostomatogasteridae","macropilina","eupodoidea","tydeioidea","alycidae",
     "anystidae","tarsonemidae","teneriffidae")]<-1

#japyjapidae
mG[c("diplura"),c("protura","symphyla","onichiuridae","isotomidae","enchytraeida",
                  "entomobridae","hipogastruridae","carrion","bac","fungi","proto")]<-1


mG["larva_carabidae",c("enchytraeida","nem_predador","nem_omnivor","nem_fitofago",
                   "nem_bacterivoro","nem_fungivoro","proto")]<-1

#cienpies: todo tipo de artrópodo conforman su presa

mG["geophylomorpha",c("alycidae","anystidae","ameroseidae","bdelloidea","cunaxide",
                      "arctacaridae","enchytraeida","astigmata","limnozetidae",
                      "ceratozetoidea", "diplura","entomobridae",
                      "dermanisoidea","ichtyostomatogasteridae","macropilina",
                   "epilhomanioidea","eremobelbidae","eupthiracaroidea","eupodoidea",
                   "eviphididae","galumnidae","hipogastruridae","isotomidae",
                 "mesostigmata","laelapidae","larva_coleoptero","larva_curculionidae",
                 "larva_diptera","larva_elateridae","larva_sciaridae",
                 "ologamasidae","parasitidae","blattodea","carabidae",
                 "onichiuridae","oppioidea","oribatulidae","penthalidae",
                   "oripodidae","protura", "scheloribatidae","symphyla",
                   "symphypleona", "teneriffidae","rhodacarioidea","tardigrado",
                  "rhagidiidae","tydeioidea","uropodoidea","veigaioidea",
                 "aphidoidea","cicadidae","coleoptera_suctor","cryptophagidae",
                 "diplopoda","juvenil","elateriforme","hemiptero","larva_carabidae",
                 "ptilidae","staphiliniidae","thysanoptera","trogossitidae",
                   "tarsonemidae","tenebrionidae","terebrantia","trombidiidae"
                  )]<-1

#arácnidos 
mG[c("linyphiidae","lycosidae"),
   c("coccinelidae","aphidoidea","arctacaridae","astigmata",
     "limnozetidae","blattodea","carabidae","grillopalpidae",
     "ceratozetoidea","cicadidae","coleoptera_suctor","cryptophagidae",
     "cunaxide","diplura","elateriforme","entomobridae",
     "eremobelbidae","eupodoidea","eviphididae","macropilina","ortoptero",
     "formicidae","galumnidae","geophylomorpha","penthalidae","tenebrionidae",
     "hemiptero","hipogastruridae","isotomidae",
     "laelapidae","mesostigmata","ologamasidae",
     "oribatulidae","oripodidae","parasitidae",
     "ptilidae","staphiliniidae","symphyla","dermanisoidea",
     "symphypleona","thysanoptera","trogossitidae",
     "tydeioidea","uropodoidea","veigaioidea","anthribidae",
     "embrioptera","terebrantia","trombidiidae"
     )]<-1

#topogrillo
mG["grillopalpidae",c("carrion","bac","fungi","tej_veg","enchytraeida",
                      "nem_predador","nem_omnivor","nem_fitofago",
                   "nem_bacterivoro","nem_fungivoro","proto",
                   "diplura","entomobridae","hipogastruridae","isotomidae",
                  "onichiuridae","oppioidea","oripodidae","protura",
                  "symphyla","symphypleona","rhodacarioidea","tardigrado"
                  )]<-1
#hormigas, predadores generalistas.
#Atacan lombrices
#"carrion","fungi","tej_veg",

mG["formicidae",c("Aporrectodea caliginosa","Aporrectodea rosea",
                  "Aporrectodea trapezoides","Bimastos beddardi sophiae",
                  "Eukerria halophila","Glossoscolex sp.",
                  "Bimastos parvus","arctacaridae","enchytraeida",
                  "astigmata","limnozetidae","embrioptera","grillopalpidae",
                  "macropilina","Microscolex phosphoreus",
                  "Octalasion cyaneum",
                  "Octolasion tyrtaeum","ortoptero","penthalidae",
                      "ceratozetoidea", "diplura","entomobridae",
                   "epilhomanioidea","eremobelbidae","eupthiracaroidea","eupodoidea",
                   "eviphididae","galumnidae","hipogastruridae","isotomidae",
                 "mesostigmata","laelapidae","larva_coleoptero","larva_curculionidae",
                 "larva_diptera","larva_elateridae","larva_sciaridae",
                 "ologamasidae","parasitidae","bdelloidea","blattodea","carabidae",
                 "onichiuridae","oppioidea","oribatulidae","pupa_diptera",
                   "oripodidae","protura", "scheloribatidae","symphyla",
                   "symphypleona", "teneriffidae","rhodacarioidea",
                  "rhagidiidae","tydeioidea","uropodoidea","veigaioidea",
                 "aphidoidea","cicadidae","coleoptera_suctor","cryptophagidae",
                 "diplopoda","juvenil","elateriforme","hemiptero","larva_carabidae",
                 "ptilidae","staphiliniidae","thysanoptera","trogossitidae",
                 "alycidae","ameroseidae","anthribidae","anystidae","coccinelidae",
                 "tenebrionidae","terebrantia"
                  )]<-1

#parasito de grandes insectos
mG["nematomorpha",c("aphidoidea","blattodea","carabidae",
    "cicadidae","coleoptera_suctor","cryptophagidae",
    "elateriforme","hemiptero","ptilidae","staphiliniidae","thysanoptera","trogossitidae")]<-1


#microfitofagos
mG[c("macropilina","limnozetidae","oribatido",
     "scheloribatidae","oripodidae","oribatulidae",
     "protura","eremobelbidae","oppioidea","brachychthonioidea"),c("bac","fungi","hummus")]<-1
#macrofitofago
mG[c("symphypleona","crotonioidea"),c("bac","fungi","hummus","tej_veg","litter")]<-1
mG[c("epilhomanioidea","eupthiracaroidea","isoptera"),c("litter")]<-1
mG[c("isoptera"),c("hummus")]<-1
#macrofitofago omnivoro
mG[c("ceratozetoidea","onichiuridae","isotomidae",
     "scheloribatidae","symphyla"),
   c("bac","fungi","hummus","carrion","litter","tej_veg","nem_fungivoro",
     "nem_bacterivoro")]<-1
#omnivoro
mG[c("entomobridae"),c("bac","fungi","nem_bacterivoro","nem_fungivoro")]<-1


mG["galumnidae",c("carrion","nem_fitofago","tardigrado",
                   "nem_bacterivoro","nem_fungivoro","proto","bac","fungi")]<-1

mG["hipogastruridae",c("nem_predador","nem_omnivor","nem_fitofago",
                   "nem_bacterivoro","nem_fungivoro","proto",
                   "tardigrado","bac","fungi","carrion")]<-1
######

mG[c("protura","symphyla"),c("carrion","bac","fungi","proto")]<-1

mG["ptilidae",c("hummus","fungi","carrion","bac","proto","nem_fitofago",
                   "nem_bacterivoro","nem_fungivoro")]<-1

#agregar crotonioidea; Octalasion lacteum; Microscolex dubius; Eukerria stagnalis; brachychthonioidea
#provenientes de la comunidad Rosana
}

```




```{r redes, echo=FALSE}
#red global "diveridad gamma"
G_net <- graph_from_adjacency_matrix(t(mG),mode=c("directed") )
#Red Lote UNLu
L_net <-graph_from_adjacency_matrix(t(mG[c(L$taxa,"litter","carrion","tej_veg","hummus"),c(L$taxa,"litter","carrion","tej_veg","hummus")]),mode=c("directed") )
#Red Reserva UNLu
R_net <-graph_from_adjacency_matrix(t(mG[c(R$taxa,"litter","carrion","tej_veg","hummus"),c(R$taxa,"litter","carrion","tej_veg","hummus")]),mode=c("directed") )
#Red Pastizal UNLu
P_net <-graph_from_adjacency_matrix(t(mG[c(P$taxa,"litter","carrion","tej_veg","hummus"),c(P$taxa,"litter","carrion","tej_veg","hummus")]),mode=c("directed") )

#Datos de ácaros - colémbolos -lombrices - y respiración heterotrófica
#Red Pastizal Naturalizado RO
N_net <-graph_from_adjacency_matrix(t(mG[c(N$specie,"litter","carrion","tej_veg"),c(N$specie,"litter","carrion","tej_veg")]),mode=c("directed") )
#Red mixto Agrícola Ganadero RO
G_net <-graph_from_adjacency_matrix(t(mG[c(G$specie,"litter","carrion","tej_veg"),c(G$specie,"litter","carrion","tej_veg")]),mode=c("directed") )
#Red agrícola intensivo RO
A_net <-graph_from_adjacency_matrix(t(mG[c(A$specie,"litter","carrion","tej_veg"),c(A$specie,"litter","carrion","tej_veg")]),mode=c("directed") )


```

```{r ady_matrix, echo=FALSE}
#aca colocar la tabla 
gamma_matrix <- as.data.frame(as.matrix(G_net, "edgelist"))
names(gamma_matrix)<-c("Recurso","Consumidor")
kableExtra::kable(gamma_matrix)
```

```{r multiweb,echo=FALSE}
library(multiweb)
#plot_troph_level(G_net,modules=TRUE,vertexLabel = TRUE, tk = TRUE)

#####
# índices topológicos
calc_topological_indices(G_net)
calc_topological_indices(L_net)
calc_topological_indices(R_net)
calc_topological_indices(P_net)

calc_topological_indices(A_net)
calc_topological_indices(G_net)
calc_topological_indices(N_net)

```

```{r plot_redes, echo=FALSE, warning=FALSE}
par(mfrow=c(1,3))
plot_troph_level(R_net,modules=TRUE,vertexLabel = FALSE, tk = FALSE)
plot_troph_level(P_net,modules=TRUE,vertexLabel = FALSE, tk = FALSE)
plot_troph_level(L_net,modules=TRUE,vertexLabel = FALSE, tk = FALSE)

plot_troph_level(N_net,modules=TRUE,vertexLabel = FALSE, tk = FALSE)
plot_troph_level(G_net,modules=TRUE,vertexLabel = FALSE, tk = FALSE)
plot_troph_level(A_net,modules=TRUE,vertexLabel = FALSE, tk = FALSE)


par(mfrow=c(1,1))
```


```{r multiweb1, echo=FALSE}

#Agrícola
{#genero el edge list
edge_list_UNLu <- as.data.frame(as.matrix(L_net, "edgelist"))
names(edge_list_UNLu)<-c("recurso","consumidor")

#a cada nodo agrego el peso corporal y la densidad 
v_ig<-data.frame(nombre=c(L$taxa,"litter","carrion","tej_veg","hummus"),peso=body_L,densidad=bm_L/body_L)

###########
#se asume que la relacion densidad de recurso y peso es 1
#cuando no el consumidor no deppende del peso del recurso
#asignandos pesos
v_ig[v_ig$nombre=="litter","peso"]<-1
v_ig[v_ig$nombre=="carrion","peso"]<-1 #tomo el mínimo y lo llevo a unidad
v_ig[v_ig$nombre=="tej_veg","peso"]<-1 #peso de las raices por centímero
v_ig[v_ig$nombre=="hummus","peso"]<-1 #la mitad de la carroña, a dedo, es un componente amorfo y no tiene una unidad en concreto lo mismo las demás recursos.
#asignando densidades a los recursos
v_ig[v_ig$nombre=="litter","densidad"]<-1
v_ig[v_ig$nombre=="carrion","densidad"]<-1 #tomo el mínimo y lo llevo a unidad
v_ig[v_ig$nombre=="tej_veg","densidad"]<-1 #peso de las raices por centímero
v_ig[v_ig$nombre=="hummus","densidad"]<-1
# con bucle busco asignar a cada eje su correspondiente peso corporal y densidad

###########
#estas son las suposiciones previas
#v_ig[v_ig$nombre=="litter","peso"]<-100
#v_ig[v_ig$nombre=="carrion","peso"]<-1 #tomo el mínimo y lo llevo a unidad
#v_ig[v_ig$nombre=="tej_veg","peso"]<-1000 #peso de las raices por centímero
#v_ig[v_ig$nombre=="hummus","peso"]<-0.5 #la mitad de la carroña, a dedo, es un componente amorfo y no tiene una unidad en concreto lo mismo las demás recursos.
#asignando densidades a los recursos
#v_ig[v_ig$nombre=="litter","densidad"]<-bm_L[72]/100
#v_ig[v_ig$nombre=="carrion","densidad"]<-bm_L[73]/1 #tomo el mínimo y lo llevo a unidad
#v_ig[v_ig$nombre=="tej_veg","densidad"]<-bm_L[74]/1000 #peso de las raices por centímero
#v_ig[v_ig$nombre=="hummus","densidad"]<-bm_L[75]/0.5
# con bucle busco asignar a cada eje su correspondiente peso corporal y densidad
###########

edge_list_UNLu$peso_consumidor<-NA
# columna peso del consumidor
for (pc in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$consumidor==as.character(v_ig$nombre[pc]),"peso_consumidor"]<-v_ig$peso[pc]
}

#columna peso del recurso
edge_list_UNLu$peso_recurso<-NA
for (pr in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$recurso==as.character(v_ig$nombre[pr]),"peso_recurso"]<-v_ig$peso[pr]
}

#columna densidad del consumidor
edge_list_UNLu$densidad_consumidor<-NA
for (dc in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$consumidor==as.character(v_ig$nombre[dc]),"densidad_consumidor"]<-v_ig$densidad[dc]
}
#columna densidad del recurso
edge_list_UNLu$densidad_recurso<-NA
for (dr in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$recurso==as.character(v_ig$nombre[dr]),"densidad_recurso"]<-v_ig$densidad[dr]
}

edge_list_UNLu$dimension<-"2D"
}
#edge_list_UNLu[edge_list_UNLu$peso_recurso==0|edge_list_UNLu$peso_recurso==-999,"peso_recurso"]<-1e-15
#edge_list_UNLu[edge_list_UNLu$peso_consumidor==0|edge_list_UNLu$peso_consumidor==-999,"peso_consumidor"]<-1e-15
#error
#Ya tengo todos los componentes solicitados

# Para detritos litter, carrion, etc. el tamaño del recurso res_mm y la densidad del recurso res_den están desacoplados del tamaño del consumidor, hay que asignar 1 a ambos 

interaction_strenght_UNLu<-calc_interaction_intensity(da=edge_list_UNLu,
                         res_mm =peso_recurso,res_den = densidad_recurso,
                        con_mm = peso_consumidor, int_dim =dimension )

#multiplicar qRC por la densidad el consumidor para que de la fuerza de interaccion total, sino es por unidad de peso del consumidor

IS_ig_UNLu<-interaction_strenght_UNLu[,c(1,2,11)]
names(IS_ig_UNLu)<-c("recurso","consumidor","weight")

QSS_IS_UNLu<-graph_from_data_frame(IS_ig_UNLu,directed = TRUE, vertices =NULL)

#edge_attr_names(QSS_IS_UNLu)
#E(QSS_IS_UNLu)
quasi_unlu<-calc_QSS(QSS_IS_UNLu, istrength=TRUE, returnRaw = FALSE, nsim=10)


#acá colocar los gremios tróficos
# o los taxas
#usar en su lugar calc_QSS_extinction_dif_grp
#QSS_unlu_seq<-calc_QSS_extinctions_seq(QSS_IS_UNLu, seq = V(QSS_IS_UNLu)$name[20:25], nsim = 100, ncores = 4, istrength = TRUE)



```

```{r flux, echo=FALSE}
library(fluxweb)
#litter carrion tej_veg hummus
body_L<-c(L$body,0,0,0,0)
body_R<-c(R$body,0,0,0,0)
body_P<-c(P$body,0,0,0,0)
# Biomasas
# Hojarasca, Dato tomado de biomasas y abundancias de la red unlu
# Esto es el peso de la hojarasca encontrada en los 25*25 cm
# 0.3 es el coeficiente de peso seco
# L= 77,0321g/0.0625m2*0.3 P= 58.63g/0.0625m2*0.3 R= 55.753g/0.065m2*0.3
# asumir 40% de la MOS es POM
# %MO L=2.73% R=3.52% P= 3.09%
# dap aprox. 1.2
# Datos tomados de fyq_unlu, determinación de la materia orgánica.
# Tej_veg sin datos, seria conocer el peso de las raices y/o sus metabolitos liberados
# Como proxy, decimos que es una vez y media el contenido de materia orgánica
# Carroña, puede ser el 5% de la biomasa promedio total de los invertebrados
# L = 6980566 *0.01, R= 9231538*0.01, P=7122637*0.01
# Fórmula: mean(P[P$taxa!="fungi"&P$taxa!="bac"&P$taxa!="proto",]$biomass)
#Lavelle: Root biomass may be extremely high in soils and often constitutes the major resource for soil organisms. 
#raices 2mg por cm en figure III.19 soil organims. root. pp 237
#####
bm_L<-c(L$biomass,
        (77.0321/0.0625)*0.3*1e6, #Hojarasca
        mean(R[R$taxa!="fungi"&R$taxa!="bac"&R$taxa!="proto",]$biomass)*0.05, #Carroña
        1.25*0.0273*1.2*50000*1e6,#Tej_veg
        0.4*0.0273*1.2*50000*1e6)#humus; 0.4 proxi POM, %MO, 1.2 DAP, 50k volumen suelo
bm_R<-c(R$biomass,
        55.753/0.065*0.3*1e6, #Hojarasca
        mean(R[R$taxa!="fungi"&R$taxa!="bac"&R$taxa!="proto",]$biomass)*0.05, #carroña
        1.25*0.0352*1.2*50000*1e6, #tej_veg
        0.4*0.0352*1.2*50000*1e6) #"humus" = POM = 0.4MO
bm_P<-c(P$biomass,
        (58.63/0.0625)*0.3*1e6, #Hojarasca
        mean(P[P$taxa!="fungi"&P$taxa!="bac"&P$taxa!="proto",]$biomass)*0.05, #carroña
        1.25*0.0352*1.2*50000*1e6, #Tej_veg
        0.4*0.0309*1.2*50000*1e6) #Humus
#######
#tasas metabolicas, 
# usamos la para "invertebrados" de flux web package
#
# 17.17 W^ -0.29

t_metL<- 17.17*body_L^(-0.29)
t_metL[is.na(t_metL)|t_metL==Inf]<-0
t_metR<- 17.17*body_R^(-0.29)
t_metR[is.na(t_metR)|t_metR==Inf]<-0
t_metP<- 17.17*body_P^(-0.29)
t_metP[is.na(t_metP)|t_metP==Inf]<-0

#Para las eficiencias, generar una columna, con eficiencias por tipo de consumidor

ef_L<- c(L$ef,NA,NA,NA,NA)
ef_R<- c(R$ef,NA,NA,NA,NA)
ef_P<- c(P$ef,NA,NA,NA,NA)

flux_L<-fluxing(t(mG[c(L$taxa,"litter","carrion","tej_veg","hummus"),c(L$taxa,"litter","carrion","tej_veg","hummus")]) ,biomasses = bm_L, losses =  t_metL, efficiencies =  ef_L,ef.level = "pred")

#ef.level	
#Set to "prey" if efficiencies are defined by prey, "pred" if they are a property of the predator.
flux_R<-fluxing(t(mG[c(R$taxa,"litter","carrion","tej_veg","hummus"),c(R$taxa,"litter","carrion","tej_veg","hummus")]) ,biomasses = bm_R, losses =  t_metR, efficiencies =  ef_R,ef.level = "pred")

flux_P<-fluxing(t(mG[c(P$taxa,"litter","carrion","tej_veg","hummus"),c(P$taxa,"litter","carrion","tej_veg","hummus")]) ,biomasses = bm_P, losses =  t_metP, efficiencies =  ef_P,ef.level = "pred")

```

```{=html}
<!--Flux web paper say:  Here we use resilience as a definition of
stability. Resilience is determined from the Jacobian matrix. The system is
in a stable equilibrium only if the real parts of eigenvalues from the Jacobian
are all negative. In this case, resilience is the absolute value of the real part
of the largest eigenvalue, ... -->
```
```{r flux_, echo=FALSE}
#Red Lote con Flujo energia

L_netf<-asNetwork(L_net)

L_netf %e% "flux" <- flux_L

#Reserva
R_netf<-asNetwork(R_net)

R_netf %e% "flux" <- flux_R

#Pastizal
P_netf<-asNetwork(P_net)

P_netf %e% "flux" <- flux_P


```

```{r qss, echo=FALSE}
#se puede calcular el QSS, me da positivo :(
calc_QSS(intergraph::asIgraph(L_netf), nsim=100)

#plot_troph_level(intergraph::asIgraph(L_netf),modules=TRUE,vertexLabel = TRUE, tk = TRUE)

# QSS es la proporcion de simulaciones que dan negativo
# medida de lo que falta de auto regulacion para que sea estable
# para estadistica usar la funcion raw= TRUE, distribuciones. 

```

```{r stability, echo=FALSE}

#para igraph
#gestionar Nodos y Ejes
#Para ver el atributo de clase Network P_netf %e% "flux"

#V(inet2)$name <- c("A","B","C","D","E")
#E(inet2)$val <- c(1:6)
#flujo<-L_netf%e%"flux"
L_igf<-intergraph::asIgraph(L_netf)
#L_ig<- graph_from_adjacency_matrix(flux_L,mode=c("directed") )
E(L_igf)$"flux"<-L_netf%e%"flux"
E(L_igf)$"dim"<-"2D"
V(L_igf)$"densidad"<-bm_L/body_L
V(L_igf)$"body_mass"<-body_L
V(L_igf)$"names"<-c(L$taxa,"litter","carrion","tej_veg","hummus")

{#genero el edge list
edge_list_UNLu <- as.data.frame(as.matrix(L_net, "edgelist"))
names(edge_list_UNLu)<-c("recurso","consumidor")

#a cada nodo agrego el peso corporal y la densidad 
v_ig<-data.frame(nombre=c(L$taxa,"litter","carrion","tej_veg","hummus"),peso=body_L,densidad=bm_L/body_L)

###########
#se asume que la relacion densidad de recurso y peso es 1
#cuando no el consumidor no deppende del peso del recurso
#asignandos pesos
v_ig[v_ig$nombre=="litter","peso"]<-1
v_ig[v_ig$nombre=="carrion","peso"]<-1 #tomo el mínimo y lo llevo a unidad
v_ig[v_ig$nombre=="tej_veg","peso"]<-1 #peso de las raices por centímero
v_ig[v_ig$nombre=="hummus","peso"]<-1 #la mitad de la carroña, a dedo, es un componente amorfo y no tiene una unidad en concreto lo mismo las demás recursos.
#asignando densidades a los recursos
v_ig[v_ig$nombre=="litter","densidad"]<-1
v_ig[v_ig$nombre=="carrion","densidad"]<-1 #tomo el mínimo y lo llevo a unidad
v_ig[v_ig$nombre=="tej_veg","densidad"]<-1 #peso de las raices por centímero
v_ig[v_ig$nombre=="hummus","densidad"]<-1
# con bucle busco asignar a cada eje su correspondiente peso corporal y densidad

###########
#estas son las suposiciones previas
#v_ig[v_ig$nombre=="litter","peso"]<-100
#v_ig[v_ig$nombre=="carrion","peso"]<-1 #tomo el mínimo y lo llevo a unidad
#v_ig[v_ig$nombre=="tej_veg","peso"]<-1000 #peso de las raices por centímero
#v_ig[v_ig$nombre=="hummus","peso"]<-0.5 #la mitad de la carroña, a dedo, es un componente amorfo y no tiene una unidad en concreto lo mismo las demás recursos.
#asignando densidades a los recursos
#v_ig[v_ig$nombre=="litter","densidad"]<-bm_L[72]/100
#v_ig[v_ig$nombre=="carrion","densidad"]<-bm_L[73]/1 #tomo el mínimo y lo llevo a unidad
#v_ig[v_ig$nombre=="tej_veg","densidad"]<-bm_L[74]/1000 #peso de las raices por centímero
#v_ig[v_ig$nombre=="hummus","densidad"]<-bm_L[75]/0.5
# con bucle busco asignar a cada eje su correspondiente peso corporal y densidad
###########

edge_list_UNLu$peso_consumidor<-NA
# columna peso del consumidor
for (pc in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$consumidor==as.character(v_ig$nombre[pc]),"peso_consumidor"]<-v_ig$peso[pc]
}

#columna peso del recurso
edge_list_UNLu$peso_recurso<-NA
for (pr in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$recurso==as.character(v_ig$nombre[pr]),"peso_recurso"]<-v_ig$peso[pr]
}

#columna densidad del consumidor
edge_list_UNLu$densidad_consumidor<-NA
for (dc in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$consumidor==as.character(v_ig$nombre[dc]),"densidad_consumidor"]<-v_ig$densidad[dc]
}
#columna densidad del recurso
edge_list_UNLu$densidad_recurso<-NA
for (dr in 1:length(v_ig$nombre)) {edge_list_UNLu[edge_list_UNLu$recurso==as.character(v_ig$nombre[dr]),"densidad_recurso"]<-v_ig$densidad[dr]
}

edge_list_UNLu$dimension<-"2D"
}
#edge_list_UNLu[edge_list_UNLu$peso_recurso==0|edge_list_UNLu$peso_recurso==-999,"peso_recurso"]<-1e-15
#edge_list_UNLu[edge_list_UNLu$peso_consumidor==0|edge_list_UNLu$peso_consumidor==-999,"peso_consumidor"]<-1e-15
#error
#Ya tengo todos los componentes solicitados

# Para detritos litter, carrion, etc. el tamaño del recurso res_mm y la densidad del recurso res_den están desacoplados del tamaño del consumidor, hay que asignar 1 a ambos 

interaction_strenght_UNLu<-calc_interaction_intensity(da=edge_list_UNLu,
                         res_mm =peso_recurso,res_den = densidad_recurso,
                        con_mm = peso_consumidor, int_dim =dimension )

#multiplicar qRC por la densidad el consumidor para que de la fuerza de interaccion total, sino es por unidad de peso del consumidor

E(L_igf)$"int_strength"<-interaction_strenght_UNLu$qRC

IS_ig_UNLu<-interaction_strenght_UNLu[,c(1,2,11)]
names(IS_ig_UNLu)<-c("recurso","consumidor","weight")

QSS_IS_UNLu<-graph_from_data_frame(IS_ig_UNLu,directed = TRUE, vertices =NULL)

edge_attr_names(QSS_IS_UNLu)
E(QSS_IS_UNLu)
(quasi_unlu<-calc_QSS(QSS_IS_UNLu, istrength=TRUE, returnRaw = FALSE, nsim=10))



QSS_unlu_seq<-calc_QSS_extinctions_seq(QSS_IS_UNLu, seq = (QSS_IS_UNLu)$name, nsim = 100, ncores = 4, istrength = TRUE)


IS_ig_UNLu.W<-interaction_strenght_UNLu[,c(1,2,11)]
names(IS_ig_UNLu.W)<-c("recurso","consumidor","weight")

QSS_IS_UNLu.w<-graph_from_data_frame(IS_ig_UNLu.W,directed = TRUE, vertices =NULL)

#E(QSS_IS_UNLu)$weight<-IS_ig_UNLu$qRC 

#calc_QSS_extinction_dif(g=QSS_IS_UNLu.w,  sp_list=V(QSS_IS_UNLu.w)$name[5,15,8] , nsim = 10, ncores = 4, istrength = FALSE) 
```

```{r plot,echo=FALSE}

plot_troph_level(QSS_IS_UNLu.w,modules=TRUE,vertexLabel = FALSE, tk = FALSE)

```

# Ro red

```{=html}
<!-- ver también, https://github.com/robertwbuchkowski/soilfoodwebs 
análisis con C y N "estequimetría"-->
```




<!--
#Para 1mgCO2 / 100g suelo * hora son 20.6 mg C-microbiano / 100g suelo
#Estos datos estan en mgCO2 /20 g suelo * dia
#Entonces multplico x 5 (a 100 g) divido * 24 (h/dia) luego multiplico por factor 20,6
# En un m2 a 10 cm son 100k cm3 por el DAP pero con 100 g suelo queda solo 1k*DAP

#####Factor de conversión de respiración microbiana = 4292000 = 4,3e6, para que quede en **microgramos**

#Materia organica particulada, es el proxi del humus, se asume que el 30% del mismo es hummus, aunque la bibliografia sugiere entre 40 al 60 % seré pesimista, entonces quearía POM en ug/m2

#octalaceom cyaneum es mas chico que lacteum, tuve que reordenar la base de datos

#base <-completo%>% mutate(bm=RESP*DAP*4.292e6,POM=0.3*(MO/100)*DAP*1e11,specie=case_when(specie=="octa_la"~"octacy",specie=="octa_cy"~"octala",specie!="octa_la"|specie!="octa_cy"~specie),biomass=case_when(order=="crassiclitellata"~exp(biomass*(1e-6))*1000,order!="crassiclitellata"~biomass))



#segun YOU IA, se requieren 1 Tn hoja seca para 0,5%MO por hectarea, es decir que por m2 son 0,1 kg de hojas

-->
Se realizan varias suposiciones:

Sobre el humus, se considera que lo utilizable como recurso es el 30% de
la %MO en los primeros 10 cm La relación H:B será por el momento
N25-G30-A35 de bacterias:hongos en los sistemas N G A respectivamente.
Además protozoos y otra microfauna representará el 5% e la respiración

Según Digel

\|Taxón \| Peso corporal \|

\|Bacteria \|9,5 x 10\^-16 g\|

\|Ameba \|2,8 10\^-8 g\|

\|Ciliados \|2,63 10\^-9 g\|

\|Flegelados \|3,03 10\^-7 g\|

\|------------\|-----------\|

\|bacterívoros \|8,5 x 10\^-7\|

\|omnivoros \|6,02 x 10\^-5\|

\|predadores \|3,56 x 10\^-6\|

\|fungivoros \|5,35 x 10\^-7\|

\|fitófagos root feeding \|2,35 x 10\^-7\|

Peso promedio de los protozoos en 1,1121 x10\^-4 µg

Nematodos son 10⁵ ind/m2 biomasa tomada de potapov y digel. En este caso
la proporción de fungivoros 40 % y bacterivoros sera igual en todos 30%
predadores 8% omnivoros 8% 14% fitofagos.

Nemátodos 15 x 10⁵ ind/m² un poco por debajo de lo que encontró Mondino
en su tesis doctoral, unque el rango varío ampliamente de 2,67 a 18,58
Asumiendo como 15 x10⁵ ind nemátodos / m² y los porcentajes de gremios
más arriba, entonces tendríamos una biomasa de:

bacterívoros 8,5 x 10\^-7; ==\> x450 x10³ ind/m² ==\> 382, 5 µg/m²
omnivoros 6,02 x 10\^-5; ==\> x120 x10³ind/m² ==\> 7224 µg/m² predadores
3,56 x 10\^-6; ==\> x120 x10³ind/m² ==\> 427 µg/m² fungivoros 5,35 x
10\^-7; ==\> x600 x10³ ind/m² ==\> 321 µg/m² fitófagos root feeding 2,35
x 10\^-7; ==\> x210 x10³ ind/m² ==\> 49,35 µg/m²

Serían 8404 µg nemátodos/m²

Número de protozoos por gramo de suelo Ameba 123x10³ =\> x 2,8 10\^-8
=\>3,4 10\^-3 g/g suelo =\> 274,19 g/m2 Flagelados 27.3x10³ =\> x 3,03
10\^-7 =\> 8,2719 10\^-3 g/g suelo =\> 667,08 g/m2 Ciliados 12.1 x 10³
=\> x 2,63 10\^-7 =\> 3,1823 x10\^-3 g/g suelo =\> 256,63 g/m2

Protozoos en un gramo de suelo según Vargas y Hattori 1990 Microbiology
Ecology 74 (1990) 73-78

5480 protozoos por gramo de suelo activos según Griffiths and Ritz soil
Biol. Biochem. Vol. 20. No. 2.pp163-173 (1998)

Tardígrados número por 10 cm³ suelo entre 250 individuos según Bingemer
et al. 2020 Zoological Journal of the Linnean Society 188. 887-899

Potapov en el Bosque tropical de indonesia calculó de hojarasca 11kg/ha
en Miramar hemos encontrado 700 g/m2

Microfauna calculada como 6,57 x10 \^-5 g, es el promedio de protozoos y
nemátodos sería 0.066 µg peso

La materia orgánica particulada es el proxi a la cantidad de recurso que
se corresponde con el Humus y esta es una fracción del %de MO
(Biological indicator of Soil Healt pp 70 - 71)

El 0.25% de lo que corresponde a microfauna sera no nematodo.

```{r matrix_gamma_ro, include=FALSE}

#lista de especies
esp<-as.vector(levels(as.factor(base$specie)))
#completar con los recursos
esp_full<-c("carrion","tej_veg","hummus","bacterias","hongos","microfauna","enquitreido","nem_pre","nem_om","nem_fit","nem_bac","nem_fun",esp)

#construcción full matrix
#crear matriz, dimensiones igual al número de especies y recursos
m0<-matrix(nrow = 64,ncol = 64,dimnames = list(esp_full,esp_full))
#reemplazar NA por ceros

m0[is.na(m0)] <- 0
#en esta matriz no incluyo la hojarasca...
#Recursos
m0["bacterias",c("hummus","tej_veg","carrion")]<-1
m0["hongos",c("hummus","tej_veg","carrion")]<-1
m0["microfauna",c("bacterias","hummus","microfauna")]<-1
m0["enquitreido",c("bacterias","hummus","microfauna","hongos")]<-1
m0["nem_pre",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","microfauna")]<-1
m0["nem_om",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","microfauna","bacterias","hongos")]<-1
m0["nem_fit",c("tej_veg")]<-1
m0["nem_fun",c("hongos")]<-1
m0["nem_bac",c("bacterias")]<-1

#Especies "reales"

m0["acaroidea",c("bacterias","hongos","nem_bac","nem_fun")]<-1

m0[c("Apo_cal","Apo_ros","Apo_tra","lom_juv","Mic_dub","Mic_pho","euker","octacy","octala"),c("bacterias","hongos","microfauna","hummus")]<-1

m0["bdelloidea",c("lom_juv","onychiuridae","hypogastruridae","isotomidae","enquitreido","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea")]<-1

m0["carabidae",c("lom_juv","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea","chylopoda","ecidomyiidae","gasteropoda","miriapodo","sciaridae","staphylinidae")]<-1

m0[c("ceratozetoidea","onychiuridae","isotomidae"),c("bacterias","hongos","hummus")]<-1

m0["chylopoda",c("enquitreido","lom_juv","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea","chylopoda","miriapodo","sciaridae","staphylinidae")]<-1

m0[c("brachychthonioidea","crotonioidea","oripodoidea","oribatido","symphypleona"),c("bacterias","hongos","hummus","tej_veg")]<-1

m0[c("dermanyssoidea","parasitoidea"),c("enquitreido","lom_juv","nem_pre","nem_om","nem_fit","nem_bac","nem_fun","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea")]<-1

m0[c("ecidomyiidae","gryllidae","scarabaeidae"),c("tej_veg")]<-1

m0[c("entomobroidea"),c("bacterias","hongos","nem_bac","nem_fun")]<-1

m0[c("epilohmannioidea"),"hummus"]<-1

m0["euphthiracaroidea",c("hummus","hongos","tej_veg")]<-1

m0["eupodoidea",c("bacterias","hongos","nem_pre","nem_om","nem_fit","nem_bac","nem_fun","onychiuridae","hypogastruridae","isotomidae","symphypleona","entomobroidea")]<-1


m0["formicidae",c("lom_juv","gryllidae","gryllotalpidae","carrion","hongos","tej_veg","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea","staphylinidae","ptiliidae","carabidae","ecidomyiidae","psocoptera")]<-1

m0["galumnioidea",c("carrion","nem_bac","nem_fun","nem_fit","bacterias","hongos")]<-1

m0["gasteropoda",c("carrion","bacterias","hongos","hummus","tej_veg")]<-1

m0["gasteropoda",c("carrion","bacterias","hongos","hummus","tej_veg")]<-1

m0["gryllotalpidae",c("carrion","bacterias","hongos","tej_veg","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","entomobroidea","nem_pre","nem_om","nem_fit","nem_bac","nem_fun","pauropoda")]<-1

m0["hypogastruridae",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","microfauna","carrion","bacterias","hongos")]<-1

m0[c("isopodos","miriapodo"),c("hummus","hongos","bacterias","microfauna")]<-1

m0["isoptera",c("hummus","hongos","bacterias","microfauna")]<-1 #,"litter"

m0["linyphiidae",c("gryllidae","gryllotalpidae","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea","staphylinidae","ptiliidae","carabidae","ecidomyiidae","psocoptera","sciaridae","scarabaeidae")]<-1

m0["mesostigmata",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","microfauna")]<-1

m0["oppioidea",c("bacterias","hongos")]<-1

m0["pauropoda",c("carrion","bacterias","hongos","microfauna")]<-1

m0["psocoptera",c("hummus","hongos")]<-1

m0["ptiliidae",c("hummus","hongos","carrion","bacterias","microfauna","nem_bac","nem_fun")]<-1

m0["rhodacaroidea",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","entomobroidea","pauropoda","enquitreido")]<-1

m0["staphylinidae",c("lom_juv","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea","nem_pre","nem_om","nem_fit","nem_bac","nem_fun","enquitreido")]<-1

m0["symphila",c("hongos","bacterias","microfauna","hummus","tej_veg")]<-1

m0["trombidioidea",c("lom_juv","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","parasitoidea","pauropoda","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea","bdelloidea","dermanyssoidea","trombidioidea","enquitreido")]<-1

m0["tydeoidea",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","hongos","bacterias","microfauna")]<-1

m0["uropodoidea",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","microfauna")]<-1

m0["veigaioidea",c("nem_pre","nem_om","nem_fit","nem_bac","nem_fun","onychiuridae","hypogastruridae","isotomidae","symphypleona","symphila","entomobroidea","pauropoda","brachychthonioidea","ceratozetoidea","crotonioidea","entomobroidea","epilohmannioidea","euphthiracaroidea","eupodoidea","galumnioidea","mesostigmata","oribatido","oripodoidea","oppioidea","rhodacaroidea","tydeoidea","uropodoidea","veigaioidea")]<-1


```

#Libro sobre uso de statnet

```{r}
#la red global; es necesario completar con todas las interacciones probables en la Pampa Húmeda.
#Determina la red Potencial.
#global_net, es g_net.

g_net<-network(t(m0),vertex.attrnames=esp_full)
resumen_red_global<-summary(g_net)
#Red con 64 nodos
#Grafo dirigido
#Tipo lista de ejes; edjelist
#Total de enlaces 528
#Densidad de enlaces 0.1309524 aprox 0.131
#Según Maggioto et al. 2019 densidad de enlaces promedios 1.68, con 14 nodos
#El cálculo de densidad en Maggioto no es el mismo que el del libro 
#Ya que este varía de 0 a 1.

#gplot(g_net,diag = TRUE,displaylabels = FALSE,mode="mds")

#scalado multidimensional métrico
```

```{r metricas_ro, echo=FALSE}

print("TAMAÑO DE LA RED")
network.size(g_net)
#Densidad
print("DENSIDAD DE LA RED, DENSIDAD DE ENLACES")
gden(g_net)

#subgrupos
print("COMPONENTES")
components(asIgraph(g_net))
count_components(asIgraph(g_net))

# asNetwork()
#No existen subgrupos fuerte o débilmente conectados

#Nos genera una matriz con las distancias geodesicas esto es los caminos más cortos
#El valor Inf nos indica los nodos desconectados
print("Distancias geodésicas")
distancias_geodesicas<-geodist(g_net)
#De todos los caminos más cortos, el más largo es el diámetro de la red
table(distancias_geodesicas$gdist)
#ignorando al Inf y mirando la matriz 
#el diámetro sería 3.
#Esto implica una red vastante condensada y con caminos de información energía cortos

#Transitividad, esto indica la formación de triángulos cerrados en la red. 
#Que es una forma básica de agrupamiento o clusters.
print("Transitividad")
gtrans(g_net)
#####
#Transitividad, proporción de triángulos
tr_Gn<-gtrans(asNetwork(G_net))
tr_Ln<-gtrans(asNetwork(L_net))
tr_Rn<-gtrans(asNetwork(R_net))
tr_Pn<-gtrans(asNetwork(P_net))
#transforma edgelist en matriz
#as.sociomatrix(g_net)

#atributos de nodos
#grado de nodos
print("Grado del nodo")
grado_nodo<-degree(asIgraph(g_net))
hist(grado_nodo)
summary(grado_nodo)
#Grado 0-5 y 15-20 son iguales en abundancias, luego 10-15, 30-40,

print("Cercania del nodo")
cercania_nodo<-closeness(asIgraph(g_net))
hist(cercania_nodo)
summary(cercania_nodo)
print("Entre quienes del nodo")
entre_quien_nodo<-betweenness(asIgraph(g_net))
hist(entre_quien_nodo)
summary(entre_quien_nodo)
# nodo_gg gran grupo
#Esto es a que gran grupo o gremio pertenece el nodo
nodo_gg<-c("rec.base","rec.base","rec.base","microflora","microflora","microfauna","mesof","microfauna","microfauna","microfauna","microfauna","microfauna","acari","clitelata","clitelata","clitelata","acari","acari","macro","acari","macro","acari","acari","macro","colem","acari","clitelata","acari","acari","macro","acari","macro","macro","macro","colem","macro","macro","colem","macro","clitelata","acari","clitelata","clitelata","macro","clitelata","clitelata","colem","acari","acari","acari","acari","mesof","mesof","macro","acari","macro","macro","macro","mesof","colem","acari","acari","acari","acari")

table(nodo_gg)

#Esto es el manejo de nodos según statnet
#set.vertex.attribute(g_net, "gran_grupo", nodo_gg)

g_net %v% "gran_grupo" <- nodo_gg

g_net %v% "grado_nodo" <- degree(asIgraph(g_net))/10

g_net %v% "cercania_nodo" <- closeness(asIgraph(g_net))/10

g_net %v% "entre_quien_nodo" <- betweenness(asIgraph(g_net))/10

g_net %v% "k_core_nodo" <- graph.coreness(asIgraph(g_net))

#g_net %v% "vertex.names"

#para igraph
#gestionar Nodos y Ejes
#V(inet2)$name <- c("A","B","C","D","E")
#E(inet2)$val <- c(1:6)

#para ver los atributos
print("Lista de atributos del nodo")
list.vertex.attributes(asIgraph(g_net))
print("Lista de atributos de los ejes")
list.edge.attributes(asIgraph(g_net))
#get.vertex.attribute(asIgraph(g_net), "na")
#Atributos de los ejes
print("Configuración ejes, nodo a nodo")
#print(get.adjedgelist(asIgraph(g_net)))

#g_net %v% "gran_grupo"

#Filtrar redes según el atributo del nodo

#get.inducedSubgraph(g_net,which(g_net%v%"gran_grupo"=="clitelata"))
```

```{r plot_RO,echo=FALSE}



#plot(g_net,label="gran_grupo",usearrows=FALSE,vertex.col="gran_grupo",vertex.cex="grado_nodo",mode="fruchtermanreingold")

#write.csv(g_net, file = "red_global.csv", row.names = FALSE)

x<-c(-1,2,4,1,3,1.5,-2,-1.5,3,2,1,0,2,0,-1,3,1,0,1,3,2,4,-2.5,1,4,-1,-2,1.5,0.5,3,1,-3,0,2,5.5,-1,1.5,3,-2.5,1.5,2,2.5,2,3,3.5,-0.5,-0.5,-1.5,2.5,3.7,3,4.5,3,2,1.7,1,4,4,-0.75,1.75,-1.75,-0.75,0.75,1.75)*2.7

y<-c(1,1,1,2,2,2.5,4,4,3.5,3,3,3,5,4,4,4,6,5,11,5,8,5,6,4,5.5,5,4,5,6,8,5,4,7,7,5.5,7,7,5.5,8,4,6,4,4,7,4,4,5.5,5,5,5,6,5.5,6.5,6.5,6,7.5,4,8,5.5,5.5,6,6,6,6)*3
     
coord=cbind(x,y)

#Tuve que seguir la guía pag 69 libro Statnet
#Para que los nodos me quedasen en un formato color amigable.
paleta_color<-RColorBrewer::brewer.pal(9, "Set1")
fact_gran_grupo<-as.factor(get.vertex.attribute(asIgraph(g_net),"gran_grupo"))


plot(g_net,coord=coord,vertex.col=paleta_color[fact_gran_grupo],vertex.cex="grado_nodo",suppress.axes = FALSE)

```

#Flux web packge

Implementacion *Falta tasas metabolicas por especie* Tal vez
preferencias alimenticias *Entender el tema de flujos* Utilizar la
salida de flujos como atributo de ejes *Clasificar los organismos por
gremios como atributo del nodo* Clasificar por funcion ecologica, para
atributo de nodo y para calcular el flujo de energía \*Entender que
significa el valor de estabilidad tambien

```{r flux_RO,echo=FALSE}
library(fluxweb)
#porque todo a mano ?
peso<-c(NA,NA,NA,9.5e-16,-999,3e-8,9e-5,3.56e-6,6.02e-5,2.35e-7,8.5e-7,5.35e-7,2.13e-6,2.16e-2,1.04e-2,0.65,9.6e-7,1.84e-6,5.45e-6,1.187e-5,7.713e-5,5.08e-6,6.03e-6,8.033e-5, 6.82e-6,2.15e-6,0.013,1.119e-5,6e-7,1.16e-4,2.994e-5,7.04e-5,1.03e-4,1.33e-4,6.73e-6,2.35e-3,4.131e-5,2.32e-6,6.715e-5,2e-3,1.022e-5,0.017,4.5e-3,2.3e-3,0.374,0.0862,9.72e-7,8.4e-7,1.11e-6,4.11e-6,8.77e-6,5e-6,3.6e-5,5.51e-4,4.64e-6,3.25e-3,3.42e-4,2.64e-4,1.68e-6,2.55e-6,8.2e-6,0.71e-6,1.4e-5,1.09e-5)
#Pasar todos los valores a microgramos
#La carroña será el 5%de la biomasa de todos los invertebrados excepto bacterias hongos
#Enquitreidos tomado de soil biology guide en promedio 11,5 g/m2 pero a peso seco 
#asumiendo 15%MS son 1,7g/m2

biomasas<-c(7.5323,1.5865,1533.87,0.0952,0.2221,0.00507,1.772,9.46e-4,9.46e-4,1.67e-3,3.55e-3,4.73e-3,2.36e-3,3.7873,1.081,4.531,1.525e-3,1.551e-3,5.384e-3,1.31e-2,3.92e-2,6.91e-3,7e-3,4.1e-2,9.52e-3,4.84e-3,2.3986,1.65e-2,3.1e-3,0.207,3.43e-2,0.1394,0.0523,0.06786,0.15476,1.19,0.02805,4.273e-2,0.041,0.6562,0.01823,1.9747,0.1803,3.51,25.14,7.204,0.0207,6.7e-3,3.53e-3,8.12e-2,5.49e-3,2.5e-3,0.01842,0.2807,6.68e-3,1.6,0.134,0.47,1.5e-3,7.68e-3,7.31e-3,1.826e-3,9.76e-3,1.07e-2)


#biomasas*100

#Por el momento eficiencias iguales
eficiencias<- rep(0.2, times = 64)
#eficiencias[c(1,2,3,5)]<- 0


#The \textbf{losses} parameter will be defined in this context as metabolic rates.
t_met<- 0.71*peso^(-0.25) #Esta tasa metabólica es la sugerida en el paper. Pero es diferente según la taxa 
#Esto lo puedo encontrar en Brown et al. creo. Luego filtrar, yasociar cada tasa a su grupo
t_met[c(1,2,3,5)]<-0


#Error imposible calcular segun los datos. RESUELTO
flux<-fluxing(t(m0) ,biomasses = biomasas, losses =  t_met, eficiencias, bioms.losses = TRUE,ef.level = "prey")

#Agregar como atributo de los ejes

g_net %e% "flujo" <- flux
g_net %e% "flujo_red" <- flux*0.05

#Asumo 1/ingreso por año
#Microgramos por tiempo, misma unidad
#Entonces 
#Carroña = ingreso 4trimestral
#Tejido vegetal ingreso diario
#Humus formacion bianual

tasa_ingreso<-c(3.33,333,0.5,rep(0, times = 61))

valor_stab<-stability.value(t(m0), biomasas, t_met, eficiencias, 
                            tasa_ingreso,bioms.prefs = TRUE,bioms.losses = TRUE,
                            ef.level = "prey" )

#warnings "especies no basales" definen tasas de crecimientos ? eso no es posible si se lo asigno a las basales ...


plot(g_net,coord=coord,vertex.col=paleta_color[fact_gran_grupo],vertex.cex="grado_nodo",suppress.axes = FALSE, edge.lwd="flujo_red",edge.col="grey")


```

[elseiver para
discu](https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/soil-food-web)
