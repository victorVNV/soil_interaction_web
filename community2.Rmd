---
title: "Análisis de las comunidades"
author: "Velazco"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r lib, include=FALSE}
#Carga paquetes
{library("tidyverse");library("readxl");library("ade4") 
library("vegan");library("cluster");library("BiodiversityR") 
library("FactoMineR");library("factoextra")}

```


```{r carga,echo=FALSE}
#Anális de datos de ROSANA
RO <- read_excel("soil_networks.xlsx", sheet = "Ro_web")
RO[is.na(RO)]<-0

resumen_bruto<-summary(RO)

```
<!--Idea para realizar análisis
Ver especies
Diversidad Alfa 
Diversidad Beta
PCoA
ANOSIM
CA
PCA y tb-PCA
K-Means-->
# Análisis de la estructura de la comunidad

Trabajaré con la base de datos completa sin considerar las submuestras,
ya que las sub muestras deben ser agrupadas para evitar la autocorrelación

Es necesario llevar las abundancias de los animales a valores de densidad
ya que las lombrices fueron tomadas con monolitos (factor= 16)
y los microartrópodos con sacabocados (factor= 509.2958).

A la vez se redondean los valores hacia el más bajo, de esta manera
las lombrices tendrían 16 ind/m² y los microartrópodos 510 ind/m².

A partir de este se calcula la Biomasa de los organismos


```{r matrices, echo=FALSE}
###############
RO_f<-RO %>% mutate(nombre=paste(system,
                                    substr(site,1,3),
                                    substr(year,3,4),
                                    substr(month,1,3)))%>%
  group_by(nombre,
           system,site,year,month,season,
           order,guild,specie) %>%
  summarise(abundance=n(), peso.ind=median(biomass), 
            bmicro=(median(bm)), 
            res.mec=median((RM5+RM10)/2),DAP=median(DAP),HR=median(HR),
            pH=median(Ph),CE=median(CE),
            MO=median(MO),N=median(N),P=median(P),K=median(K),
            Ca=median(Ca),Mg=median(Mg),Na=median(Sodio))%>%
  distinct(specie,.keep_all=TRUE)

#####################
#Llevando abundancias a densidad

sup.bocado <- 1/(pi*2.5^2/10000)
sup.monolito <- 1/(0.25*0.25)

#################
RO_full<-RO_f%>%mutate(D=floor(case_when(order=="crassiclitellata"~sup.monolito*abundance,order!="crassiclitellata"~sup.bocado*abundance)),BT=D*peso.ind)

##################
#Matriz de comunidad

abund_RO<-RO_full[,c("nombre","system","site","specie","abundance","D")] %>% 
  pivot_wider(names_from = specie,
              values_from = c(abundance,D),
              values_fill = 0,
              values_fn = sum)%>%
  distinct(nombre,.keep_all=TRUE)

peso_RO<-RO_full[,c("nombre","system","site","specie","peso.ind","BT")] %>% 
  pivot_wider(names_from = specie,
              values_from = c(BT,peso.ind),
              values_fill = 0,
              values_fn = mean)%>%
  distinct(nombre,.keep_all=TRUE)

fq_RO<-RO_full%>%group_by(nombre,
           system,site,year,month,season,
           )%>%
  summarise(res.mec=mean(res.mec),DAP=mean(DAP),HR=mean(HR),
            pH=mean(pH),CE=mean(CE),
            MO=mean(MO),N=mean(N),P=mean(P),K=mean(K),
            Ca=mean(Ca),Mg=mean(Mg),Sodio=mean(Na))%>%
  distinct(nombre,.keep_all=TRUE)
  
RO_db_full<-merge(abund_RO,peso_RO, fq_RO, by.x = "nombre", by.y = "nombre", by.z = "nombre", all = TRUE)

```

#Diversidad Alfa

## Riqueza de especies

```{r spc, echo=FALSE}

######

#Lista de especie agrupadas según el colector
#De los datos brutos de RO
#Arrastrado a partir de los agrupamientos y pivoteo en ancho
#Nombres tomados de la columnas de abun_RO y "reformateados"
spc.colector<-c("Apo_cal","Apo_tra", "Mic_dub",
                "lom_juv","isotomidae", "gastropoda", "epilohmannioidea",
                "euphthiracaroidea","oripodoidea","oppioidea",
                "onychiuridae","Apo_ros","formicidae",
                "parasitoidea","ceratozetoidea",
                "brachychthonioidea","crotonioidea","hypogastruridae",
                "eupodoidea","sciaridae","veigaioidea","ptiliidae",
                "entomobroidea","miriapoda","rhodacaroidea",
                "galumnioidea","symphila","chylopoda","carabidae",
                "ecidomyiidae","psocoptera","symphypleona",
                "staphylinidae","octala","bdelloidea",
                "isoptera","dermanyssoidea","trombidioidea",
                "octacy","gryllotalpidae","acaroidea","pauropoda",
                "tydeoidea","uropodoidea","mesostigmata","linyphiidae",
                "euker","oribatida","Mic_pho","scarabaeidae","isopoda",
                "gryllidae" )
#abund_RO[,4:55]
ab<-abund_RO[,56:107]
colnames(ab)<-spc.colector
rownames(ab)<-abund_RO$nombre

# Uso de función riqueza especies
print("#############################################")
print("Tabla de riqueza de especies por cada muestra")
Muestras<-abund_RO$nombre
Riqueza<-specnumber(ab)
data.frame(Muestras,Riqueza,row.names = NULL)

print("#############################################")
print("Tabla de riqueza de especies por cada sitio")
print(data.frame(Sitios=levels(as.factor(abund_RO$site)),Riqueza=specnumber(ab,groups=abund_RO$site),row.names = NULL))

print("#############################################")
print("Tabla de riqueza de especies en cada sistema de uso del suelo")
print(data.frame(system=levels(as.factor(abund_RO$system)),
                 Riqueza=specnumber(ab,groups=abund_RO$system),row.names = NULL))
```

## Índice de Shanon

```{r H, echo=FALSE}

library(boot)
set.seed(167)
H<-diversity(ab, index="shannon")

######################
# Función para calcular la media
mean_func <- function(data, indices) {
  mean(data[indices])
}

# Función para calcular el desvío estándar
sd_func <- function(data, indices) {
  sd(data[indices])
}

# Número de repeticiones de bootstrap
n_boot <- 1000
set.seed(167)
##############
# Realizar bootstrap para calcular la media y el desvío estándar
#Systema Agrícola
boot_mean_A <- boot(H[c(1:34)], mean_func, R = n_boot)
boot_sd_A <- boot(H[c(1:34)], sd_func, R = n_boot)

bootstrap_mean_A <- boot.ci(boot_mean_A, type = "basic")#$basic
bootstrap_sd_A <- boot.ci(boot_sd_A, type = "basic")#$basic
#Quito el $basic, porque me quita la descripción de lo que significan los valores

#Sistema Ganadero
boot_mean_G <- boot(H[c(35:64)], mean_func, R = n_boot)
boot_sd_G <- boot(H[c(35:64)], sd_func, R = n_boot)
bootstrap_mean_G <- boot.ci(boot_mean_G, type = "basic")
bootstrap_sd_G <- boot.ci(boot_sd_G, type = "basic")

#Sistema Pastizal
boot_mean_N <- boot(H[c(65:95)], mean_func, R = n_boot)
boot_sd_N <- boot(H[c(65:95)], sd_func, R = n_boot)
bootstrap_mean_N <- boot.ci(boot_mean_G, type = "basic")
bootstrap_sd_N <- boot.ci(boot_sd_G, type = "basic")

#################

print("#############################################")
print("Tabla de Promedio y desvío standar del índice de Shannon en cada sistema de uso del suelo")
print("Método no paramétrico 'boostraping'\n")
print(data.frame(system=levels(as.factor(abund_RO$system)),
                 mean=c(boot_mean_A[[1]],boot_mean_G[[1]],boot_mean_N[[1]]),
                 desvio_std=c(boot_sd_A[[1]],boot_sd_G[[1]],boot_sd_N[[1]]),
                 l.mean.int=c(bootstrap_mean_A$basic[4],bootstrap_mean_G$basic[4],
                   bootstrap_mean_N$basic[4]),
                 h.mean.int=c(bootstrap_mean_A$basic[5],bootstrap_mean_G$basic[5],
                   bootstrap_mean_N$basic[5]),
                 l.sd.int=c(bootstrap_sd_A$basic[4],bootstrap_sd_G$basic[4],
                   bootstrap_sd_N$basic[4]),
                 h.sd.int=c(bootstrap_sd_A$basic[5],bootstrap_sd_G$basic[5],
                   bootstrap_sd_N$basic[5]),row.names = NULL))


```

# Diversidad Beta

## Índice de Wilson

```{r Beta, echo=FALSE}

D_site<-RO_full[,c("system","site","specie","D")] %>% 
  pivot_wider(names_from = specie,
              values_from = c(D),
              values_fill = 0,
              values_fn = sum)%>%
  distinct(system,.keep_all=TRUE)
D_site<-as.data.frame(D_site)
row.names(D_site)<-D_site$site

beta<-betadiver(D_site[,-c(1,2)], method=8)
div.beta<-hclust(beta,method = "mcquitty")
plot(div.beta,cex=0.6)

```
Globalmente se observa separación de los diferentes sitios. El triángulo que es pastizal naturalizado esta levemente relacionado a los agrícolas.

Living communities are spatially structured at many scales, and
these structures are the result of several classes of processes. On the other hand,
beta diversity is the spatial variation in community composition; so, a study of the
factors that can explain the spatial variation of community composition is in every
respect an analysis of beta diversity. (Numerical Ecology con R pp 228)

# PCoA

```{r pcoa,echo=FALSE,warning=FALSE}
####################
# Especies como columnas
tb_ab<-decostand(ab,"total")
rownames(tb_ab)<-c(1:95)
  #c(rep("A", 34), rep("G", 30), rep("N", 31))

tb_pcoa<-vegdist(tb_ab, method="bray")

pcoa_1<-cmdscale(tb_pcoa,k=(nrow(tb_ab)-1), eig=TRUE)
{ordiplot(scores(pcoa_1)[,c(1,2)],type="t",main="Analisis de coordinadas principales",sub="Especies como descriptores")
abline(h=0,lty=3)
abline(v=0,lty=3)
spe<-wascores(pcoa_1$points[,c(1,2)],tb_ab)
#text(spe,rownames(spe),cex=0.7,col="red")
pch<-c(1,1,1,1,9, 3, 5,5,5,5,9,1,3, 6,5,5,5,9,7,3,6,3,
         9,3,6,5,10,3,3,3,3,10,3,1,7,3,6,7,1,3,5,10,
           7,6,6,3,1,5,1,3,3,3)
points(spe[,1],spe[,2],cex=0.7,col="red",pch=pch)
} #Con lista de especie 
#podes hacer caracteres pch=c(1,2,3)
#lombrices=1; macro=2; acaros_orib= 5; ac_meso= 6
#ac_prost=7; artropleona=9; no_artropleona=10

################
#Sitios como columnas
tb_sitio<-t(tb_ab)
colnames(tb_sitio)<-abund_RO$nombre
  #c(rep("A", 34), rep("G", 30), rep("N", 31))

tb_sitio_pcoa<-vegdist(tb_sitio, method="bray")

pcoa_2<-cmdscale(tb_sitio_pcoa,k=(nrow(tb_sitio)-1), eig=TRUE)
{ordiplot(scores(pcoa_2)[,c(1,2)],type="t",main="Analisis de coordinadas principales",sub="Sitios como descriptores")
abline(h=0,lty=3)
abline(v=0,lty=3)
site<-wascores(pcoa_2$points[,c(1,2)],tb_sitio)
#text(spe,rownames(spe),cex=0.7,col="red")
points(site[,1],site[,2],cex=0.8,col="red", pch=c(rep(2, 34), rep(5, 30), rep(3, 31)))
}


```


# ANOSIM

# CA

# PCA y tb-PCA

# K-Means



<https://r-bloggers.com/2019/09/understanding-bootstrap-confidence-interval-output-from-the-r-boot-package/>

< https://doi.org/10.1046/j.1365-2656.2003.00710.x>
