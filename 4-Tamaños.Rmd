---
title: "4-Tamaños"
author: "VNV"
date: "2024-03-25"
output: html_document
bibliography: size_spectra.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
loadNamespace('printr')
```

```{r lib, include=FALSE}
{require(tidyverse); require(kableExtra); require(quantreg);require(lubridate)
  require(kSamples);require(ggridges)}
```

# Introducción

Los organismos que viven en el suelo ocupan los espacios formados entre la hojarasca que se acumula sobre la superficie del suelo y los poros de la matriz organomineral del suelo [@wallwork1971; @ritz2012].

La fauna edáfica desempeña un papel fundamental en el funcionamiento edáfico mediante el consumo de materia orgánica, el transporte de propágulos de bacterias y hongos, el control de poblaciones, son los recursos alimenticios de otros organismos y median transformaciones biológicas sobre la estructura organomineral del suelo (**bioturbación o biotransformación**). Estas funciones, a su vez, contribuyen a servicios ecosistémicos más amplios como el ciclo del carbono, de los nutrientes y el agua, la regulación de la materia orgánica del suelo y la fertilidad química y física del suelo [@brussaard2012; @wurst2012; .\@.cita_paper_redesyservicios].

La identificación taxonómica de las comunidades que habitan la red de poros del suelo se dificulta debido a la gran diversidad taxonómica en constante revisión, como al pequeño tamaño corporal de la criptofauna [@briones2014], sumado a esto, los microartrópodos edáficos se caracterizan por formar una comunidad con una importante redundancia funcional debido a su gran abundancia y a sus hábitos alimenticios generalistas [@hattenschwiler2005; @walker1992].

Para avanzar en la compresión de las comunidades crípticas del suelo han tomando en cuenta características tales como el uso de clasificaciones que agrupan la criptofauna ya sea en **gremios** (taxones con requerimientos de nichos similares) o en **grupos funcionales** (taxones con funciones ecológicas específicas), como el uso de las variaciones en los **rasgos** de los individuos en cada comunidad. Esto permite avanzar sobre la caracterización de las comunidades y su estado sin considerar necesariamente su identificación hasta el nivel de especie, lo que permite mejorar la capacidad predictiva y la comprensión sobre los procesos que ocurren en las comunidades ecológicas [@moretti2017; @leguillarme2023].

Todos los organismos responden a las presiones ambientales, estas respuestas pueden observarse como cambios en los rasgos morfológicos, fisiológicos, fenológicos o de comportamiento. Las presiones que modifican las características del medio también se reflejan como cambios en la estructura poblacional de los diferentes taxones en la comunida [@sechi2017; @mittelbach2019]. Por lo tanto, el efecto de las interacciones de los organismos con su ambiente queda reflejado en las variaciones poblacionales y en las variaciones de los rasgos individuales, que pueden ser utilizados como indicadores de procesos ecológicos a nivel de la comunidad [@brussaard2012; @petchey2010].

La fauna edáfica es sensible a las perturbaciones que ocurren sobre el suelo, las actividades de manejo pueden alterar el hábitat y la fuente de los recursos que estos organismos utilizan [@lavelle2006]. Por ejemplo, las perturbaciones pueden alterar los ingresos y salidas de materia orgánica y nutrientes debido a los pulsos derivados de la aplicación de fertilizantes y pesticidas[.\@.citas_sobre_alteracion_ciclo_N], o pueden alterarse las condiciones del microclima poroso cuando se expone el suelo a factores ambientales en periodos de barbecho (p.e. cuando el cultivo no se encuentra presente), o, en sistemas ganaderos, el efecto de la compactación sobre la estructura física del suelo que afecta la distribución y el tamaño de los poros.

La estimación del tamaño corporal de los organismos edáficos, medida a partir del peso corporal, permite relacionar parámetros fisiológicos como el metabolismo y el uso de los recursos, con parámetros ecológicos tales como las interacciones tróficas y las adaptaciones de estos organismos ante cambios en el ambiente [@pey2014; @white2007; @turnbull2014].

Las variaciones del tamaño corporal en las comunidades ecológicas pueden analizarse mediante las distribuciones del peso corporal, esto es, mediante el espectro de tamaños y pueden ser relacionadas con diferentes aspectos de las comunidades, tales como, los gremios tróficos, los grupos funcionales, los habitats, las posiciones en la red trófica, entre otras [@edwards2020]. 

También es factible establecer relaciones entre el tamaño corporal y la abundancia de las especies: la abundancia permite describir la importancia numérica de los taxones presentes en el ecosistema y relacionarlos con la redundancia funcional y el funcionamiento ecosistémico [@briones2014].


Los cambios en la distribución del tamaño corporal de los organismos en una comunidad reflejan cambios en los procesos ecológicos relacionados con variaciones en el ambiente o con variaciones en la red de interaciones biológicas [@pey2014; @white2007], a su vez, la relación directa de ambos parámetros constituye la biomasa media que mide la cantidad de materia orgánica retenida por los actores en la red de interacciones y vincula el metabolismo y el flujo de energía que atraviesa los nodos [@potapov2019]. 


De esta manera, los cambios en la biomasa, en el espectro de tamaños o en ambos, enlazan la historia de vida de los organismos y la respuesta individual a las presiones ambientales, con la estructura y dinámica de las comunidades, y, con los efectos subsecuentes sobre los procesos ecológicos y con el funcionamiento del ecosistema [@sechi2017; @moretti2017; @blanchard2017; @jonsson2005; @peters1986] y pueden dar cuenta de efectos diferenciales debidas a las intensidades de las perturbaciones sobre el ecosistema del suelo asociadas con el uso antrópico.

Mediante el análisis de la biomasa y del espectro de tamaños de la fauna edáfica que habitan suelos Argiudoles típicos de la Pampa Ondulada sometidos a diferentes sistemas de manejo se pretende conocer la respuesta diferencial de dichas comunidades y determinar cuáles son los efectos del manejo antrópico sobre el espectro de tamaño de los geobiontes; por lo que se espera que la fauna respondan a los efectos del uso del suelo y que los efectos se vean reflejados sobre los gremios tróficos de la fauna edáfica.

<!-- Esto es demasiado largo para una sola oracion y deberia ser el planteo del objetivo de este capitulo. ¿A ver algo asi? "El objetivo de esta parte de la tesis es el de estudiar posibles diferencias en los espectros de tamaño que puedan reflejar los efectos del manejo antrópico sobre la comunidad de microartrópodos edàficos" -->

## Estimación del peso corporal individual de la fauna edáfica

La macrofauna edáfica con tamaños mayores a 1 cm de longitud, previamente identificada, fue
llevada a estufa a 60ºC hasta pesada constante para estimar el peso seco mediante balanza 
analítica con precisión de 1 mg. Para la fauna edáfica con menores tamaños corporales se tomaron
fotografías de cada individuo colectado y montados temporalmente, con un esteroscopio Leica (S8AP0) con cámara fotográfica incluida y escala de referencia integrada (Leica Application Suite V4.4).
Mediante el software ImageJ se tomaron las longitudes del largo y ancho corporal que permite estimar
el peso corporal corporal utilizando ecuaciones morfométricas [@rasband2018; @newton2013] estas son
ecuaciones lineales que consideran la forma general del taxa y su relaciones con el largo y el ancho
corporal [.\@.velazco2023citasizespectra]. Las ecuaciones utilizadas son presentadas en la tabla 4.1. <!-- poner las ecuaciones aquí debajo, completarlas-->

A partir de los pesos corporales ( $\mu g_ {\;p.s.}$ ) de cada individuo se calculó el valor del peso corporal medio para el taxón ( $\mu g_{\;p.s.}$ ), también se calcularon los valores de densidad por taxón ( $no. ind/m^{-2}$ ) extrapolando a partir de los valores de abundancias y en función del marco de muestreo a partir de ambas variables se obtuvo la biomasa total promedio ( $\mu g_{p.s.} * m^{-2}$ ). Además a cada taxón se asigno una categoría de gremio trófico en función del uso que hacen de los recursos tróficos [@velazco2023; @simberloff2022a]

**Tabla 4.1. Ecuaciones morfométricas que relacionana el largo y el ancho corporal para estimar el peso corporal de los taxones de la fauna edáfica según su forma característica** <!-- controlar y corregir --> 

Identificador de la ecuación |Autoría |Taxón |Coeficientes |Coeficiente de peso seco |Observaciones 
--------|------|----|------------|-----------------|-----------
1 |Tanaka 1970 |Hipogastrura manubrialis |b= 2,78 ±  0,24 ; a= 0,71 ±  0,025 |expressed as dry biomass | log Y (weigth in ug) = b * log X (length in mm) + a
2 |Tanaka 1970  |Onychiurus spp. and Isotomids	|b= 2,55 ±  0,93 ; a= 0,99 ±  0,088 |expressed as dry biomass | log Y (weigth in ug) = b * log X (length in mm) + a
3	|Tanaka 1970  |Onychiurus spp. |b= 2,75 ±  0,34 ; a= 0,63 ±  0,037 |expressed as dry biomass | log Y (weigth in ug) = b * log X (length in mm) + a
3.1 |Tanaka 1970  |Entomobriidae |b= 2,5 ±  0,38 ; a= 1,07 ±  0,04 |expressed as dry biomass | log Y (weigth in ug) = b * log X (length in mm) + a
3.2	|Tanaka 1970 |Symphypleona	|b= 3,71 ; a= 6,89	|expressed as dry biomass | log Y (weigth in ug) = b * log X (length + width in mm) + a
4	|Lebrum Philippe. (1971) |Achipteriforme	|log P = 2,09 log L + 0,93 log l – 6,67	|0,4 |*coef según Persson and Lohm, (1977);  Fórmulas Oribátidos según Morfología
5	|Lebrum Philippe. (1971) |Nothriforme	|log P = 2,09 log L + 0,84 log l – 6,44	|0,4 |*coef según Persson and Lohm, (1977);  Fórmulas Oribátidos según Morfología
6	|Lebrum Philippe. (1971) |Carabodiforme	|log P = 1,62 log L + 1,40 log l – 6,56	|0,4 |*coef según Persson and Lohm, (1977);  Fórmulas Oribátidos según Morfología
7	|Lebrum Philippe. (1971) |Forma general utilizada en la tabla 9 |Log P = 1,53 log L + 1,53 log l – 6,67	|0,4	|*coef según Persson and Lohm, (1977);  Fórmulas Oribátidos según Morfología
8	|Persson and Lohm, (1977)	|Trombidiformes	|^3^√W = 0,00387 * L de Edwards 1967 $\Rightarrow$ W = (0,00387* L)^3^	|0,4	|*coef según Persson and Lohm, (1977)
9	|Persson and Lohm, (1977)	|Mesostigmatas	|W = 0,85 * ( L ^2,09^ * l ^0,84^ * 10 ^-6,44^ )	|0,4	|* coef según Persson and Lohm, (1977)
10 |Ganihar (1997) |Aracnida 	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~= -3.2105 ; b~1~= 2.4681 |expressed as dry biomass		
11 |Ganihar (1997) |Coleoptera adulto	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~= -3.2689 ; b~1~= 2.4625	|expressed as dry biomass |	Expresado en miligramos	
12 |Ganihar (1997) |Coleoptera larva |ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~= -7,1392 ; b~1~= 0,8095 |expressed as dry biomass| Expresado en miligramos
13 |Ganihar (1997) |Díptera	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~= -3,4294 ; b~1~= 2,5943 |expressed as dry biomass |
14 |Ganihar (1997) |Formicidae |ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~= -3,1415 ; b~1~= 2,3447	|expressed as dry biomass |
15 |Hawkins et al. (1997) |Gasterópoda	 | Y = 0,172* X^1,688^ (log transformed:  ln(Y)  = 0.199  +  1.688 . ln(X)) | expressed as dry biomass | Expresado en miligramos de peso seco y Longitud en mm y la mitad porque va del centro al labio		16	|Ganihar 1997 |Insecta	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~=-3,0710 ; b~1~=2,2968	|expressed as dry biomass|		
17	|Ganihar 1997 | Isopoda	| weight = b~0~  + b~1~ * (length); b~0~=-1,1167 ; b~1~=0,4762	|expressed as dry biomass	|	
18	|Coulis & Joly 2017 peso fresco	|Diplopoda miriapoda	|ln (weigth) = 2,38* ln(length)-2,77	|0,45	|*Según Edwards 1967 en Lebrum Philippe. (1971)	
19	|Ganihar 1997 |Collembola utilizado para pauropoda	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~=-1,8749 ; b~1~=2,3002 |	expressed as dry biomass	|	
20	|Ganihar 1997 |Chilopoda Scolopendromorfa	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~=-6,7041 ; b~1~=2,8420 |expressed as dry biomass |
21	|Persson and Lohm (1977)	|Ecuación Pauropoda peso fresco en microgramos|	W=(1,20+L)^3	|0,2 |		
22	|Ganihar 1997 |Ortóptera	|ln (weight) = ln b~0~ + b~1~ * (length); ln b~0~=-3,5338 ; b~1~=2,4619	|expressed as dry biomass |
23 |Tita et al. 1999 |Nemátoda |weight = ((530 * L * W^2^)*1,084)/4 |expressed as dry biomass |
24 |Hale et al. 1999 |Oligochaeta | ln (weight~af~) = 2.6365*ln(length)-12,6 |expressed as dry biomass ash-free | length in milimeter |
25 |Greiner et al. 2010 |Enchitraeid | ln (weight~af~) = 1.10*ln(length)-8,22 |expressed as dry biomass ash-free | length in milimeter |

## Análisis estadístico

Se resumen las valores medio de densidad, biomasa y pesos corporales de los taxones en cada sistema de manejo, para observar posibles diferencias estructurales dentro de la fauna edáfica relacionadas con el impacto del uso del suelo en los diferentes sistemas de manejo.

Para cada comunidad se analizó la respuesta de la biomasa media de cada gremio trófico vinculado con el efecto de los sistemas de manejo, a la vez se abordaron las posibles relaciones causales que podrían afectar la respuesta de la biomasa media ya sea por el efecto de las estaciones del año o por los estratos en el cuál habitan los taxas y las interacciones entre estos.

El análisis se realizó utilizando un modelo lineal multifactorial y pruebas post-hoc de Tukey HSD para evaluar diferencias de medias de manera simultánea.

Las relaciones entre los pesos corporales medios y las abundancias se abordó mediante el uso de la regresión sobre el tercer cuartil [@white2007], que permite, obtener una relacion de regresión sin realizar supuestos sobre la distribución de las variables, además el tercer cuartil disminuye el efecto de las especies raras y permite centrarse en los valores más probables del peso adulto de los invertebrados edáficos [@cade2003; @turnbull2014].

Mediante la regresión sobre el tercer cuartil se realizaron comparaciones entre los interceptos y las pendientes para evaluar la existencia de diferencias, las relaciones de estas con las características ecológicas y el impacto de las actividades antrópicas sobre las comunidades de los microartrópodos edáficos [@cade2003]; para ello se hizo uso del paquete "quantreg" [.\@.buscarcitadelpaquete] que permite realizar modelos de regresión de cuartiles y utilizar técnicas de remuestreo (bootstraping) no paramétricas para evaluar las diferencias. 

Se relacionó el peso corporal medio versus la densidad en relación a dos factores: los gremios tróficos y los sistemas de uso del suelo; este enfoque es conocido en inglés como *"Local Size-Density Relationships (**LSDR**)"* y expresa que valores de pendientes más pronunciadas se relacionan con impactos fuertes sobre los taxones [@white2007].

Las variables fueron transformadas con logaritmos naturales, debido a que la distribución de cada uno de los pesos corporales en conjunto y por cada sistema de uso (Fig. 4.1) ajustan a la distribución logarítmica normal [@koch1966]. Todos los análisis se realizaron R 4.2.1 [@clauset2009; @crawley2013].


<!-- colocar las imágenes de las curvas de acumulación empírica-->

# Resultados y Discusión

## Densidades y pesos corporales por grupo taxonómicos

```{r limp_dtb,include=FALSE}
body_unlu <- read.delim("database/community_bodymass.txt")
names(body_unlu)<-c("sitio","replica","microhabitat","taxa","length","width","body_mass")
#microhábitat diferencia entre hoja gruesa, hojafragmentada y humus
body_unlu[body_unlu$sitio == "L", "sitio"] <- "A"
#corrección peso de tardígrados
body_unlu[body_unlu$taxa == "tardigrado", "body_mass"]<-body_unlu[body_unlu$taxa == "tardigrado", "body_mass"]/100

body_unlu$estrato<-body_unlu$microhabitat
#estrato queda por los 3 estratos, esto hace a la replicabilidad
body_unlu$estrato[body_unlu$microhabitat=="Frag"|body_unlu$microhabitat=="Hoja"|
                    body_unlu$microhabitat=="hoja"|body_unlu$microhabitat=="humus"]<-"H"

body_unlu<-body_unlu[,c(c("sitio","replica","estrato","microhabitat","taxa","body_mass"))]

#corrección nombres duplicados o erróneos
{body_unlu$taxa[body_unlu$taxa=="Apodorrectodeacaliginosa"|
                 body_unlu$taxa=="Aporrectodeacaliginosa"]<-"Aporrectodea_caliginosa"
body_unlu$taxa[body_unlu$taxa=="Apodorrectodeatrapezoides"|
                 body_unlu$taxa=="Aporrectodeatrapezoides"]<-"Aporrectodea_trapezoides"
body_unlu$taxa[body_unlu$taxa=="Aporrectodearosea"]<-"Aporrectodea_rosea"
body_unlu$taxa[body_unlu$taxa=="Bimastosbeddardisophiae"]<-"Bimastos_beddardi_sophiae"
body_unlu$taxa[body_unlu$taxa=="Bimastosparvus"]<-"Bimastos_parvus"
body_unlu$taxa[body_unlu$taxa=="entomobridae"|
                 body_unlu$taxa=="entomobridae"|
                 body_unlu$taxa=="entomobriidae"]<-"entomobryoidea"
body_unlu$taxa[body_unlu$taxa=="Eukerriahalophila"]<-"Eukerria_halophila"
body_unlu$taxa[body_unlu$taxa=="insecto_polinizador"|
                 body_unlu$taxa=="insecto_suctor"]<-"hemiptera"
body_unlu$taxa[body_unlu$taxa=="larva_carabidae"|
                 body_unlu$taxa=="larva_carabido"]<-"larva_carabidae"
body_unlu$taxa[body_unlu$taxa=="larva_diptera"|
                 body_unlu$taxa=="larva_diptero"]<-"larva_diptera"
body_unlu$taxa[body_unlu$taxa=="larva_scarabidae"]<-"larva_scarabaeidae"
body_unlu$taxa[body_unlu$taxa=="larva_staphynilidae"]<-"larva_staphylinidae"
body_unlu$taxa[body_unlu$taxa=="Microscolexphosphoreus"]<-"Microscolex_phosphoreus"
body_unlu$taxa[body_unlu$taxa=="Microscolexphosphoreus"]<-"Microscolex_phosphoreus"
body_unlu$taxa[body_unlu$taxa=="Octalasioncyaneum"]<-"Octalasion_cyaneum"
body_unlu$taxa[body_unlu$taxa=="Octolasiontyrtaeum"]<-"Octolasion_tyrtaeum"
body_unlu$taxa[body_unlu$taxa=="paholaspidae"]<-"parholaspidae"
body_unlu$taxa[body_unlu$taxa=="pupa_diptero"|
                 body_unlu$taxa=="pupa_insecto"|
                 body_unlu$taxa=="pupadíptera"]<-"pupa_diptera"
body_unlu$taxa[body_unlu$taxa=="raghididae"|
                 body_unlu$taxa=="rhagididae"]<-"rhagidiidae"
body_unlu$taxa[body_unlu$taxa=="staphiliniidae"|
                 body_unlu$taxa=="staphylinidae"]<-"staphylinidae"
#correccion glososscolex
body_unlu$taxa[body_unlu$taxa=="Glossoscolexsp."]<-"Octolasion_tyrtaeum"
body_unlu$taxa[body_unlu$taxa=="hemiptera"|
                 body_unlu$taxa=="hemiptero"|
                 body_unlu$taxa=="heteroptera"]<-"hemiptera"
body_unlu$taxa[body_unlu$taxa=="gasteropoda"|
                 body_unlu$taxa=="gastropoda"]<-"gasteropoda"
body_unlu$taxa[body_unlu$taxa=="macropilina"]<-"lohmanidae"

}

#asignamos gremios. Predadores, Omnivoros, Detritivoros, Microfitofagos, Herviboros
body_unlu$gremio<-NA
#predadores
body_unlu$gremio<-ifelse(
  body_unlu$taxa%in%c("alycidae","amerosidae","arannae","arctacaridae","coccinelidae",
                      "bdelloidea","carabidae","cunaxide","dermanisoidea","eupodoidea",
                      "eviphididae","formicidae","geophylomorpha","grillopalpidae",
                      "ichtyostomatogasteridae","japygiidae","laelapidae","larva_carabidae",
                      "larva_staphylinidae","linyphiidae","lycosidae","mesostigmata",
                      "nematomorpha",
                      "ologamasidae","parajapygidae","parasitidae","parholaspidae",
                      "penthalidae","predador","pseudoscorpionida","rhagidiidae",
                      "rhodacaroidea","staphylinidae","tarsonemidae","tenerifidae",
                      "trogossitidae","tydeoidea","uropodidae"),"predador",
  ifelse(
    body_unlu$taxa%in%c("anthribidae","Aporrectodea_caliginosa","Aporrectodea_rosea",
                        "coleoptera",
                        "Aporrectodea_trapezoides","Bimastos_beddardi_sophiae",
                        "Bimastos_parvus",
                        "blattodea","ceratozetoidea",
                        "diplopoda","elateriforme","enquitreido","epilhomanioidea",
                        "Eukerria_halophila","eupthiracaroidea","Glossoscolex","isotomidae",
                        "juvenil","larva_coleoptero","larva_curculionidae","larva_diptera",
                        "larva_scarabaeidae","larva_tenebrionidae",
                        "Microscolex_phosphoreus","Octalasion_cyaneum","Octolasion_tyrtaeum",
                        "oniscoidea","oribatido","oripodidae","ptinidae","ptilidae",
                        "pupa_diptera",
                        "pythidae","scheloribates","symphypleona","tenebrionidae"
                        ),"detritivoro",
    ifelse(
    body_unlu$taxa%in%c("bacterivoro","cryptophagidae","entomobryoidea",
                        "eremobelbidae","fungivoro","galumnidae","gasteropoda",
                        "larva_elateridae","larva_sciaridae","limnozetidae","lohmanidae",
                        "macropilina","onichiuridae","oppioidea","oribatulidae",
                        "protura","psocoptera","symphyla"
                        ),"microfitofago",
    ifelse(
      body_unlu$taxa%in%c("afido","cicadidae","fitofago",
                          "hemiptera","ortoptero","trip","terebrantia"),"herbivoro",
      ifelse(
        body_unlu$taxa%in%c("astigmata","hipogastruridae",
                            "larva_elateridae","omnivoro","tardigrado"
                            ),"omnivoro",body_unlu$gremio
      )))))

#datos$food <- ifelse(datos$taxa %in% especies_predadoras, "predadora",
#            ifelse(datos$taxa %in% especies_herbivoras, "herbívora",
#            ifelse(datos$taxa %in% especies_omnivoras, "omnívora", datos$food)))


#correción celda
#araña de 4 son 400 microgramos 
body_unlu[4163,"body_mass"]<-400

### clase de tamaño para calcular densidad

body_unlu$clase_tam<-NA
#predadores
body_unlu$clase_tam<-ifelse(
  body_unlu$taxa%in%c("bacterivoro","fitofago","fungivoro","omnivoro","predador"),"micro",
  ifelse(
    body_unlu$taxa%in%c("alycidae","amerosidae","arctacaridae",
                        "astigmata","bdelloidea","ceratozetoidea","cunaxide",
                        "dermanisoidea","enquitreido","entomobryoidea",
                        "epilhomanioidea","eremobelbidae","eupodoidea",
                        "eupthiracaroidea","eviphididae","galumnidae",
                        "hipogastruridae","ichtyostomatogasteridae",
                        "isotomidae","japygiidae","laelapidae","limnozetidae","lohmanidae","macropilina",
                        "mesostigmata","ologamasidae","onichiuridae","oppioidea",
                        "oribatido","oribatulidae","oripodidae","parajapygidae",
                        "parasitidae","parholaspidae","penthalidae","protura",
                        "rhagidiidae","rhodacaroidea","scheloribates",
                        "symphyla","symphypleona","tardigrado","tarsonemidae","tenerifidae",
                        "tydeoidea","uropodidae"),"meso",
    ifelse(
    body_unlu$taxa%in%c("anthribidae","Aporrectodea_caliginosa","Aporrectodea_rosea",
                        "Aporrectodea_trapezoides","arannae","Bimastos_beddardi_sophiae",
                        "Bimastos_parvus","blattodea","carabidae","cicadidae","coccinelidae",
                        "coleoptera","cryptophagidae","diplopoda","diptera","elateriforme",
                        "Eukerria_halophila","formicidae","gasteropoda","geophylomorpha",
                        "Glossoscolex","grillopalpidae","hemiptera","juvenil","larva_carabidae",
                        "larva_coleoptero","larva_curculionidae","larva_elateridae",
                        "larva_scarabaeidae","larva_staphylinidae","larva_tenebrionidae",
                        "linyphiidae","lycosidae", "Microscolex_phosphoreus","nematomorpha",
                        "Octalasion_cyaneum","Octolasion_tyrtaeum","oniscoidea","ortoptero",
                        "pseudoscorpionida","psocoptera","ptilidae","ptinidae","pythidae",
                        "staphylinidae","tenebrionidae","terebrantia","trogossitidae",
                        "trips","larva_sciaridae","larva_diptera","afido","pupa_diptera"),"macro",
    body_unlu$clase_tam)))


forbody_unlu<-body_unlu

#taxones
bodyU_taxa<-levels(as.factor(body_unlu$taxa))

```

```{r dtbRO,include=FALSE}
completo <- read_csv2("database/body_fq_guil_22.csv" , locale = readr::locale(encoding = "ISO-8859-1"))

#Superficie en metros cuadrados a partir del sacabocados de 5 centímetros cuadrados
#factor de conversión
superficie <- pi*2.5^2/10000

#sin macrofauna
#Datos brutos, biomasa individual de microartropodos
meso <- filter(completo,class!="macrofauna"&specie!="oribátido"&specie!="mesostigmata")%>%mutate( season=fct_relevel(season, c("O","I","P","V")),habitat=fct_relevel(habitat, c("epiedaphic","hemiedaphic","euedaphic")))

#Base con biomasas promedios por especie
#sample, son submuestras, por lo que no sirve para dividir sino para promediar la muestra
base <-meso %>% group_by(system,site,year,month,sample,season,class,order,specie,guild,habitat) %>%  summarise(abundance=(n()/superficie), bio.ind=mean(biomass),Tbiomass=(bio.ind*abundance))

```

```{r resumen_dtb, include=FALSE}

baseU <-body_unlu %>% group_by(sitio, replica,estrato, microhabitat,clase_tam,gremio,taxa) %>%  summarise(abundance=n(), bio.ind=mean(as.numeric(body_mass)))
#R1	452 R2	998 R3	1207
#L1	212 L2	473 L3	378
#P1	556 P2	518 P3	636
#1.05 es el factor de aumento del 5% por pérdida
names(baseU)<-c("sitio","replica","estrato","microhabitat",
                "clase","gremio","taxa","abundance","bio.ind")
#corrigiendo densidades de nemátodos
#además se asume un error de 20% por pérdida de animales no fotografiados pero si contabilizados

baseU<-baseU%>%
  mutate(ab=floor(case_when(
  sitio=="R"&replica==1&clase=="micro"~(abundance/100)*452*1.05,
  sitio=="R"&replica==2&clase=="micro"~(abundance/100)*998*1.05,
  sitio=="R"&replica==3&clase=="micro"~(abundance/100)*1207*1.05,
  sitio=="A"&replica==1&clase=="micro"~(abundance/100)*212*1.05,
  sitio=="A"&replica==2&clase=="micro"~(abundance/100)*473*1.05,
  sitio=="A"&replica==3&clase=="micro"~(abundance/100)*378*1.05,
  sitio=="P"&replica==1&clase=="micro"~(abundance/100)*556*1.05,
  sitio=="P"&replica==2&clase=="micro"~(abundance/100)*518*1.05,
  sitio=="P"&replica==3&clase=="micro"~(abundance/100)*636*1.05,
  TRUE~abundance*1.20
  )))
  
#microfauna (se contaron los nemátodos de 4 sacabocados)
sup.bocado.micro <- (1/(pi*2.5^2/10000))*4

#mesofauna (se contaron y extrajeron de 3 frasquitos homojeneizados del monolito)
#se utiliza 1.8 ya que el volumen fue de 100 cm para una profundidad de 10 cm.
# la superficie de todo estrato diferente a 10 fue 25*25, corregir datos de densidad. 
sup.bocado.meso <- (1/(pi*1.8^2/10000))*3
#macrofauna (superficie estandar 25 x 25)
sup.monolito <- 1/(0.25*0.25)

baseU<-baseU%>%mutate(
             D=floor(case_when(
  clase=="macro"~sup.monolito*ab,
  clase=="meso"~sup.bocado.meso*ab,
  clase=="micro"~sup.bocado.micro*ab)
  )
  )


```

```{r densidad_peso_unlu, echo=FALSE, warning=FALSE}
Dp_U_m<-baseU%>%filter(clase=="micro")%>%group_by(taxa,sitio)%>%summarise('Peso corporal'=round(mean(bio.ind),1), Densidad=round(mean(D)),'Biomasa total media'=round(mean(D*bio.ind)/1000,1)) #%>% distinct(taxa,.keep_all=TRUE)
Dp_U_me<-baseU%>%filter(clase=="meso")%>%group_by(taxa,sitio)%>%summarise('Peso corporal'=round(mean(bio.ind),1), Densidad=round(mean(D)),'Biomasa total media'=round(mean(D*bio.ind)/1000,1)) #%>% distinct(taxa,.keep_all=TRUE)
Dp_U_Ma<-baseU%>%filter(clase=="macro")%>%group_by(taxa,sitio)%>%summarise('Peso corporal'=round(mean(bio.ind),1), Densidad=round(mean(D)),'Biomasa total media'=round(mean(D*bio.ind)/1000,1)) #%>% distinct(taxa,.keep_all=TRUE)

Dp_U_m%>% kbl() %>%kable_classic(full_width = F, html_font = "Cambria")
Dp_U_me%>% kbl() %>%kable_classic(full_width = F, html_font = "Cambria")
Dp_U_Ma%>% kbl() %>%kable_classic(full_width = F, html_font = "Cambria")

```


```{r den_peso_ro, echo=FALSE}

B1<-meso%>%mutate(Manejo=factor(system,labels= c("Agrícola intensivo","Agrícola-ganadero","Pastizal natural")),Taxon=factor(specie,labels=c("Acaroidea","Bdelloidea","Brachychthonioidea","Ceratozetoidea","Crotonioidea","Dermanyssoidea","Entomobroidea","Epilohmannioidea","Euphthiracaroidea", "Eupodoidea","Galumnioidea","Hypogastruridae","Isotomidae","Onychiuridae","Oppioidea","Oripodoidea","Parasitoidea","Rhodacaroidea","Symphypleona","Trombidioidea","Tydeoidea","Uropodoidea","Veigaioidea")))%>%group_by(Manejo,site,year,month,sample,Taxon)%>%summarise(peso=biomass,bio=sum(biomass), abT= n(), bioT=bio/superficie, D=abT/superficie)


B2<-B1%>%group_by(Taxon,Manejo)%>%summarise('Peso corporal'=round(mean(peso),1), Densidad=round(mean(D)),'Biomasa total media'=round((mean(bioT)/1000),2)) %>% distinct(Taxon,.keep_all=TRUE)

#'Peso corporal mínimo'=min(peso),'Peso corporal máximo'=max(peso),

B2%>% kbl() %>%kable_classic(full_width = F, html_font = "Cambria")
#caption = "Tabla I. Valores de peso corporal promedio ($ug_{p.s.}$), densidad ($no. ind/m^2$) y biomasa total ($mg_{p.s.}/m^2$) para los taxones de Acari y Collembola en cada sistema de manejo"
```


```{r KW,include=FALSE}

forbody_unlu<-body_unlu
names(forbody_unlu)<-c("sitio","replica","estrato","microhabitat",
                       "taxa","bio.ind","gremio","clase_tam")
# Crear una lista de taxones únicos en los datos
taxones <- unique(forbody_unlu$taxa)

# Inicializar listas para almacenar los resultados
resultados_kruskal <- list()
resultados_wilcoxon <- list()

# Recorrer cada taxón
for (taxon in taxones) {
  # Filtrar los datos para el taxón actual
  datos_taxon <- forbody_unlu %>% filter(taxa == taxon)
  
  # Calcular el rango de los datos
  rango <- diff(range(datos_taxon$bio.ind))
  
  # Verificar si hay suficiente variación en los datos para realizar el test
  if (length(unique(datos_taxon$bio.ind)) > 3 && length(unique(datos_taxon$sitio)) > 1) {
  # Realizar el test de Kruskal-Wallis
  resultado_kruskal <- kruskal.test(bio.ind ~ sitio, data = datos_taxon)
  
  # Almacenar el resultado en la lista
  resultados_kruskal[[taxon]] <- resultado_kruskal
  
  # Realizar comparaciones a pares con el test de Wilcoxon
  pairwise_test <- pairwise.wilcox.test(datos_taxon$bio.ind, datos_taxon$sitio, p.adjust.method = "BH",exact=FALSE)
  
  # Almacenar el resultado en la lista
  resultados_wilcoxon[[taxon]] <- pairwise_test
} else {
  cat("No hay suficientes datos distintos en los sitios para el taxón:", taxon, "\n")
}
}

# Ver los resultados
print(resultados_kruskal)
print(resultados_wilcoxon)

## Rosana
formeso<-meso

# Crear una lista de taxones únicos en los datos
taxones <- unique(formeso$specie)

# Inicializar listas para almacenar los resultados
resultados_kruskalRO <- list()
resultados_wilcoxonRO <- list()

# Recorrer cada taxón
for (taxon in taxones) {
  # Filtrar los datos para el taxón actual
  datos_taxon <- formeso %>% filter(specie == taxon)
  
  # Calcular el rango de los datos
  rango <- diff(range(datos_taxon$biomass))
  
  # Verificar si hay suficiente variación en los datos para realizar el test
  if (length(unique(datos_taxon$biomass)) > 3 && length(unique(datos_taxon$system)) > 1) {
  # Realizar el test de Kruskal-Wallis
  resultado_kruskal <- kruskal.test(biomass ~ system, data = datos_taxon)
  
  # Almacenar el resultado en la lista
  resultados_kruskalRO[[taxon]] <- resultado_kruskal
  
  # Realizar comparaciones a pares con el test de Wilcoxon
  pairwise_test <- pairwise.wilcox.test(datos_taxon$biomass, datos_taxon$system, p.adjust.method = "BH",exact=FALSE)
  
  # Almacenar el resultado en la lista
  resultados_wilcoxonRO[[taxon]] <- pairwise_test
} else {
  cat("No hay suficientes datos distintos en los sitios para el taxón:", taxon, "\n")
}
}

# Ver los resultados
print(resultados_kruskalRO)
print(resultados_wilcoxonRO)


```

## Distribución de peso corporal

```{r ridge_unlu, echo=FALSE, warning=FALSE}

body_unlu%>%filter(clase_tam=="micro")%>%
  ggplot(aes(x=log(body_mass), y=taxa, fill=gremio)) + 
  geom_density_ridges(rel_min_height = 0.001,scale=1.5,show.legend=FALSE)+ 
  scale_fill_viridis_d(alpha = 0.8)+  
  facet_grid(.~sitio)+
  labs(title='Peso corporal individual para los taxones de microartrópodos', 
       x= 'Peso corporal en ln ug/m^2',y=NULL)

body_unlu%>%filter(clase_tam=="meso"
                   &body_unlu$taxa%in%c("amerosidae","arctacaridae",
                        "bdelloidea","cunaxide",
                        "dermanisoidea","eupodoidea",
                        "eviphididae","ichtyostomatogasteridae",
                        "laelapidae",
                        "mesostigmata","ologamasidae",
                        "parasitidae","parholaspidae","penthalidae",
                    "rhagidiidae","rhodacaroidea",
                    #"tarsonemidae",#"tenerifidae", sin gráfica
                        "tydeoidea","uropodidae"))%>%
  ggplot(aes(x=log(body_mass), y=taxa, fill=gremio)) + 
  geom_density_ridges(rel_min_height = 0.001,scale = 1.5,show.legend=FALSE)+ 
  scale_fill_viridis_d(alpha = 0.8)+
  facet_grid(.~sitio)+
  labs(title='Peso corporal individual para los taxones de microartrópodos', 
       x= 'Peso corporal en ln ug/m^2',y=NULL)

body_unlu%>%filter(clase_tam=="meso"&body_unlu$taxa%in%c("alycidae",
                        "astigmata","ceratozetoidea",
                        "enquitreido","entomobryoidea",
                        "epilhomanioidea","eremobelbidae",
                        "eupthiracaroidea","galumnidae",
                        "hipogastruridae",
                      "isotomidae","japygiidae",
                      "limnozetidae","lohmanidae","macropilina",
                        "onichiuridae","oppioidea",
                    "oribatido","oribatulidae","oripodidae",
                    "parajapygidae","scheloribates",
                    "symphyla","symphypleona","tardigrado"))%>%
  ggplot(aes(x=log(body_mass), y=taxa, fill=gremio)) + 
  geom_density_ridges(rel_min_height = 0.001,scale = 2.5)+ 
  scale_fill_viridis_d(alpha = 0.8)+
  facet_grid(.~sitio)+
  labs(title='Peso corporal individual para los taxones de microartrópodos', 
       x= 'Peso corporal en ln ug/m^2',y=NULL)

body_unlu%>%filter(clase_tam=="macro")%>%
  ggplot(aes(x=log(body_mass), y=taxa, fill=gremio)) + 
  geom_density_ridges(rel_min_height = 0.001,scale = 2.5)+ 
  scale_fill_viridis_d(alpha = 0.8)+
  facet_grid(.~sitio)+
  labs(title='Peso corporal individual para los taxones de microartrópodos', 
       x= 'Peso corporal en ln ug/m^2',y=NULL)

 # scale_x_continuous(breaks = seq(from=-4, to=5, by=2))+ 



meso%>%ggplot(aes(x=log(biomass), y=specie, fill=guild)) + geom_density_ridges(rel_min_height = 0.0000005) +scale_x_continuous(breaks = seq(from=-4, to=5, by=2))+  scale_fill_viridis_d(alpha = 0.8)+facet_grid(.~system)+labs(title='Peso corporal individual para los taxones de microartrópodos', x= 'Peso corporal en ln ug/m^2',y=NULL)

```

```{r pwrU, include=FALSE}

# Ajuste espectro con paquete Power Law
# Ajuste con paquete poweRlaw con Xmin ajustado

require(poweRlaw)
source("R/functions.r")

# Ajuste a partir del minimo de los datos, esto es, considerando que 
# el valor mínimo se encuentra dentro de los datos

dist_manejoU <- body_unlu %>% group_by(sitio) %>% summarise(evaluate_distr(body_mass,est_xmin=FALSE))

dist_manejoU %>% filter(min(AICc)==AICc) %>% mutate(moda=exp(expo))

# Plots usando ggplot
#
dist_plotU <- body_unlu %>% group_by(sitio) %>% summarise(gplot=list(evaluate_distr(body_mass,est_xmin=FALSE,returnOBJ=TRUE)))

# Estimación para todos los datos

dist_totalU <- evaluate_distr(body_unlu$body_mass,est_xmin=FALSE)
dist_totalU %>% filter(min(AICc)==AICc) %>% mutate(moda=exp(expo))

dist_plot_totU <- evaluate_distr(body_unlu$body_mass,est_xmin=FALSE,returnOBJ = TRUE) 

###########
#ROSANA
# Ajuste a partir del minimo de los datos, esto es, considerando que 
# el valor mínimo se encuentra dentro de los datos

dist_manejo <- meso %>% group_by(system) %>% summarise(evaluate_distr(biomass,est_xmin=FALSE))

dist_manejo %>% filter(min(AICc)==AICc) %>% mutate(moda=exp(expo))

# Plots usando ggplot
#
dist_plot <- meso %>% group_by(system) %>% summarise(gplot=list(evaluate_distr(biomass,est_xmin=FALSE,returnOBJ=TRUE)))

# Estimación para todos los datos

dist_total <- evaluate_distr(meso$biomass,est_xmin=FALSE)
dist_total %>% filter(min(AICc)==AICc) %>% mutate(moda=exp(expo))

dist_plot_tot <- evaluate_distr(meso$biomass,est_xmin=FALSE,returnOBJ = TRUE) 
```

```{r aj, warning=FALSE, message=FALSE,echo=FALSE}

require(cowplot)

prowU <- plot_grid(
  dist_plotU$gplot[1][[1]] + xlab("Biomass")  + theme(legend.position="none")+ theme(axis.text.x = element_text(angle = 50, hjust = 1)), 
  dist_plotU$gplot[2][[1]] + xlab("Biomass")  + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + ylab(NULL),
  dist_plotU$gplot[3][[1]]  + xlab("Biomass") + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + ylab(NULL),
  dist_plot_totU  + xlab("Biomass") + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + ylab(NULL),
  align = 'vh',
  nrow = 2,
  labels = c('A', 'G','N','T' )
  )
legend_b <- get_legend(
  dist_plotU$gplot[3][[1]] +
    guides(color = guide_legend(nrow = 2)) +
    theme(legend.position = "bottom")
)
pgU <- plot_grid(prowU, legend_b, nrow = 2, rel_heights = c(1, .1));pgU

#save_plot("Figures/BodySizeSpectra_Landuses.png",pg,base_width=8,base_height=6,dpi=600)
#dist_plot$gplot[1][[1]] + xlab("Biomass")



prow <- plot_grid(
  dist_plot$gplot[1][[1]] + xlab("Biomass")  + theme(legend.position="none")+ theme(axis.text.x = element_text(angle = 50, hjust = 1)), 
  dist_plot$gplot[2][[1]] + xlab("Biomass")  + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + ylab(NULL),
  dist_plot$gplot[3][[1]]  + xlab("Biomass") + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + ylab(NULL),
  dist_plot_tot  + xlab("Biomass") + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + ylab(NULL),
  align = 'vh',
  nrow = 2,
  labels = c('A', 'G','N','T' )
  )
legend_b <- get_legend(
  dist_plot$gplot[3][[1]] +
    guides(color = guide_legend(nrow = 2)) +
    theme(legend.position = "bottom")
)
pg <- plot_grid(prow, legend_b, nrow = 2, rel_heights = c(1, .1));pg


```

```{r pwRO,include=FALSE}
```

## Biomasa

```{r B_unlu, echo=FALSE}
baseU<-baseU%>%mutate(Tbiomass=D*bio.ind)
mU<-aov(log(Tbiomass) ~ sitio * gremio * estrato,data = baseU)
mstep<-step(mU)
mU_1<-aov(log(Tbiomass) ~ sitio + gremio + estrato,data = baseU)

par(mfrow=c(2,2))
plot(mU_1)

par(mfrow=c(1,1))
```

```{r plotbtU, echo=FALSE}

baseU %>%  ggplot( aes(log(Tbiomass),sitio, fill=sitio)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+ scale_fill_viridis_d(guide="none") +  geom_jitter(alpha=0.4) +labs(subtitle="A)",y=NULL, x=expression(paste("Biomasa","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

#guild
baseU %>%  ggplot( aes(log(Tbiomass),gremio, fill=gremio)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+ scale_fill_viridis_d(guide="none") +  geom_jitter(alpha=0.4) +labs(subtitle="A)",y=NULL, x=expression(paste("Biomasa","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

baseU %>%  ggplot( aes(log(Tbiomass),estrato, fill=estrato)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+ scale_fill_viridis_d(guide="none") +  geom_jitter(alpha=0.4) +labs(subtitle="A)",y=NULL, x=expression(paste("Biomasa","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

```

```{r}
TukeyHSD(mU_1, "sitio")
TukeyHSD(mU_1, "gremio")
TukeyHSD(mU_1, "estrato")
```


```{r B_ro, echo=FALSE}

m<-aov(log(Tbiomass) ~ system * season * guild ,data = base)
mstep<-step(m)
m1<-aov(formula = log(Tbiomass) ~ system + season + guild + system:season + system:guild, data = base)


par(mfrow=c(2,2))
plot(m1)

par(mfrow=c(1,1))

TukeyHSD(m1, "system")

TukeyHSD(m1, "season")

TukeyHSD(m1, "guild")

TukeyHSD(m1, "system:season")

TukeyHSD(m1, "system:guild")
```

```{r B_ROplot, echo=FALSE}

# Sistema

base %>% ggplot( aes(log(Tbiomass),system, fill=system)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+scale_fill_viridis_d(guide="none")  +scale_x_continuous(breaks =seq(from=3, to=14, by=1))+  geom_jitter(alpha=0.4)+labs(subtitle="IV.a. Biomasa media de la comunidad de microartrópodos en los sistemas de uso",y=NULL, x=expression(paste("Biomasa total","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

# Estación
#
meso %>% mutate(season=factor(season,labels=c("Otoño","Invierno","Primavera","Verano"))) %>% group_by(system,site,year,month,sample,season,class,order,specie,guild) %>%  summarise(abundance=(n()/superficie), bio.ind=mean(biomass),Tbiomass=(bio.ind*abundance))  %>% ggplot( aes(log(Tbiomass),season, fill=season)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+  scale_fill_viridis_d(guide="none") +scale_x_continuous(breaks = seq(from=3, to=14, by=1))+  geom_jitter(alpha=0.4)+labs(subtitle="IV.b. Biomasa media de la comunidad de microartrópodos en las estaciones del año",y=NULL, x=expression(paste("Biomasa total","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

# Guild

meso %>% mutate(guild=factor(guild,labels=c("Detritívoros","Microfitófagos","Omnívoros","Predadores"))) %>% group_by(system,site,year,month,sample,season,class,order,specie,guild,habitat) %>%  summarise(abundance=(n()/superficie), bio.ind=mean(biomass),Tbiomass=(bio.ind*abundance))  %>% ggplot( aes(log(Tbiomass),guild, fill=guild)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+ scale_x_continuous(breaks = seq(from=3, to=14, by=1))+  scale_fill_viridis_d(guide="none") +  geom_jitter(alpha=0.4) +labs(subtitle="IV.c. Biomasa media de los gremios tróficos de microartrópodos",y=NULL, x=expression(paste("Biomasa total","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

# System : season

meso %>% mutate(season=factor(season,labels=c("Otoño","Invierno","Primavera","Verano"))) %>% group_by(system,site,year,month,sample,season,class,order,specie,guild,habitat) %>%  summarise(abundance=(n()/superficie), bio.ind=mean(biomass),Tbiomass=(bio.ind*abundance)) %>% ggplot( aes(y=log(Tbiomass), x=system,fill=system)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+ scale_y_continuous(breaks = seq(from=3, to=15, by=1))+scale_fill_viridis_d(guide="none") +  geom_jitter(alpha=0.4) + facet_grid(.~season) +labs(subtitle="IV.d. Biomasa media de la comunidad de microartrópodos en cada estación y en cada sistema de manejo",x='Sistemas de manejo', y=expression(paste("Biomasa total","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))

# System : guild

meso %>% mutate(guild=factor(guild,labels=c("Detritívoros","Microfitófagos","Omnívoros","Predadores"))) %>% group_by(system,site,year,month,sample,season,class,order,specie,guild,habitat) %>%  summarise(abundance=(n()/superficie), bio.ind=mean(biomass),Tbiomass=(bio.ind*abundance)) %>% ggplot( aes(y=log(Tbiomass),x= system,fill=system)) + geom_violin(alpha=0.75,trim = FALSE,draw_quantiles = 0.5) +stat_summary(fun = "mean",geom = "point",color = "white")+ scale_y_continuous(breaks = seq(from=3, to=15, by=1))+scale_fill_viridis_d(guide="none") +geom_jitter(alpha=0.4) + facet_grid(.~guild) +labs(subtitle="IV.e. Biomasa media de los gremios tróficos de microartrópodos edáficos para cada sistema de manejo",x='Sistemas de manejo', y=expression(paste("Biomasa total","  ",paste("ln"," ",mu,"g"," ")[ps]/m^2)))


```

## Relación tamaño de espectro

```{r qq_unlu, echo=FALSE}
rq0<-rq(log(D) ~ (sitio+gremio+log(bio.ind))^3, tau = .75, data = baseU)
summary(rq0,se="boot")

step(rq0)

rq1<-rq(log(D) ~ sitio + gremio + log(bio.ind) + sitio:log(bio.ind) + 
    gremio:log(bio.ind),tau = .75, data = baseU)

```

```{r qqplotU,warning=FALSE}

baseU%>%ggplot(aes(x=log(bio.ind),y=log(D),color=gremio))+
  geom_point(size=1.1,shape=8,color=1)+
  geom_quantile(quantiles = 0.75, size=1.5) +  
  scale_color_viridis_d()+facet_grid(sitio~.)+  geom_smooth()+
  labs( x=expression(paste("Biomasa corporal","  ",paste(ln," ",mu,"g")[ps])),
        y=expression(paste("Densidad","  ",ln," ","n°"[ind]/m^{2})))


baseU%>%filter(gremio!="herbivoro")%>%
  ggplot(aes(x=log(bio.ind),y=log(D),color=gremio))+
  geom_point(size=1.1,shape=8,color=1)+
  geom_quantile(quantiles = 0.75, size=1.5) +  
  scale_color_viridis_d()+facet_grid(sitio~.)+  
  labs( x=expression(paste("Biomasa corporal","  ",paste(ln," ",mu,"g")[ps])),
        y=expression(paste("Densidad","  ",ln," ","n°"[ind]/m^{2})))

baseU%>%filter(gremio=="herbivoro")%>%
  ggplot(aes(x=log(bio.ind),y=log(D),color=gremio))+
  geom_point(size=1.1,shape=8,color=1)+
  geom_quantile(quantiles = 0.75, size=1.5) +  
  scale_color_viridis_d()+facet_grid(sitio~.)+  
  labs( x=expression(paste("Biomasa corporal","  ",paste(ln," ",mu,"g")[ps])),
        y=expression(paste("Densidad","  ",ln," ","n°"[ind]/m^{2})))


```

Los herbívoros no ajustan a la linea recta, es bimodal dado en la meso fauna no es continua y en los hevíboros de mayor tamaño no estan correctamente representados linealmente.

```{r qq_RO, echo=FALSE}
rq1<-rq(log(abundance) ~ (system+guild+log(bio.ind))^2, tau = .75, data = base)
step(rq1)

base %>% mutate(system = factor(system,levels=c("N","G","A")),guild = factor(guild,levels=c("predator","microphytophages","detritivore","omnivore")))%>%rq(log(abundance) ~ (system+guild+log(bio.ind))^2, tau = .75, data = .)%>%summary(.,se="boot")

```

```{r qrplot_RO,echo=FALSE}


base%>%ggplot(aes(x=log(bio.ind), y=log(abundance),color=guild))+geom_point(size=1.1,shape=8,color=1)+geom_quantile(quantiles = 0.75, size=1.5) +  scale_color_viridis_d()+facet_grid(system~.)+  labs( x=expression(paste("Biomasa corporal","  ",paste(ln," ",mu,"g")[ps])), y=expression(paste("Densidad","  ",ln," ","n°"[ind]/m^{2})))


```



# ref

Edwards 1973 Relationships between weights, volumes and numbers of soil animals. in Progress in soil zoology

Wallwork J (1958) Notes on the Feeding Behaviour of Some Forest Soil Acarina. Oikos 9 (2). <https://doi.org/10.2307/3564770>

Ritz K, van der Putten W (2012) The living soil and ecosystem services: Introduction. In: Wall DH, et al. (Ed.) Soil ecology and ecosystem services. Oxford University Press, 421 pp. [ISBN 978-0-19-957592-3].
